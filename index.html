<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUFT - BakaNeko's Ultimate Finance Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
                        ledger: { highlight: '#f1f5f9' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f7f9; height: 100dvh; }
        @supports not (height: 100dvh) { body { height: -webkit-fill-available; } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .hide { display: none !important; }
        
        /* Clear status row fade effect */
        .item-cleared td { opacity: 0.4; transition: opacity 0.3s ease; }
        .item-cleared:hover td { opacity: 0.65; }
        .item-cleared .item-name, .item-cleared .item-amount { text-decoration: line-through; }
        
        /* Checkbox styling for recurrence grids */
        .day-checkbox input:checked + div { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        /* Modern toggle switch for auto-process */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox { right: 4px; z-index: 1; transition: all 0.3s; }
        .toggle-label { transition: all 0.3s; }

        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }

        /* Washu chat message styling */
        .washu-msg p { margin-bottom: 0.5rem; }
        .washu-msg p:last-child { margin-bottom: 0; }
        .washu-msg strong { font-weight: 700; color: #1e293b; }
        .washu-msg ul, .washu-msg ol { margin: 0.5rem 0; padding-left: 1.25rem; }
        .washu-msg li { margin-bottom: 0.25rem; }
        .washu-msg code { background: #e2e8f0; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.8em; }
        .washu-typing::after { content: 'â–Š'; animation: blink 0.7s infinite; color: #a855f7; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes washu-spin { to { transform: rotate(360deg); } }
        .washu-spinner { display: inline-block; animation: washu-spin 1s linear infinite; }
    </style>
</head>
<body class="text-slate-800 flex overflow-hidden antialiased">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-10 rounded-3xl shadow-2xl flex flex-col items-center max-w-md w-[90%] text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-brand-50 opacity-50"></div>
            <div class="relative z-10 flex flex-col items-center">
                <div class="bg-brand-600 p-4 rounded-2xl shadow-xl shadow-brand-500/30 mb-6">
                    <svg viewBox="0 0 120 100" class="w-20 h-20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 20 55 C 15 80, 30 95, 60 95 C 90 95, 105 80, 100 55 C 95 30, 90 25, 80 5 L 70 30 C 65 28, 55 28, 50 30 L 40 5 C 30 25, 25 30, 20 55 Z" fill="white" stroke="#2d1b19" stroke-width="4" stroke-linejoin="round"/>
                        <path d="M 35 48 L 45 53 L 35 58 M 85 48 L 75 53 L 85 58" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M 5 50 L 25 53 M 2 60 L 23 60 M 7 70 L 26 67 M 115 50 L 95 53 M 118 60 L 97 60 M 113 70 L 94 67" fill="none" stroke="#2d1b19" stroke-width="3" stroke-linecap="round"/>
                        <path d="M 48 65 Q 54 72 60 65 Q 66 72 72 65" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/>
                        <path d="M 52 68 C 52 88, 68 88, 68 68 Z" fill="#fbcfe8" stroke="#2d1b19" stroke-width="3"/>
                        <circle cx="32" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                        <circle cx="88" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">Welcome to BUFT</h1>
                <p class="text-sm text-slate-500 font-medium mb-8">BakaNeko's Ultimate Finance Tool</p>
                
                <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 px-6 py-3.5 rounded-xl font-bold shadow-sm transition-all transform hover:scale-105">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-app" class="flex w-full h-full opacity-0 transition-opacity duration-500 hide">
        
        <!-- ACCESS VERIFICATION GATE (Bouncer) -->
        <div id="access-gate-overlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-md z-[150] flex flex-col items-center justify-center hide opacity-0 transition-all duration-300">
            <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col max-w-lg w-[90%] relative overflow-hidden border-t-8 border-brand-500">
                <div class="flex items-center mb-6">
                    <div class="bg-brand-100 p-3 rounded-full mr-4">
                        <i class="ph-fill ph-shield-check text-3xl text-brand-600"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Private Access Required</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Disclaimer & Verification</p>
                    </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 text-sm text-slate-600 leading-relaxed">
                    <p class="mb-3">This is a private, self-hosted instance of BUFT. Access requires acknowledge of data storage on the owner's private cloud.</p>
                    <p>Contact the owner for the code at <a href="mailto:bakaneko@bakeaneko.net" class="font-bold text-brand-600 hover:underline">bakaneko@bakeaneko.net</a>.</p>
                </div>

                <form onsubmit="verifyAccessCode(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-2">Enter Invite Code</label>
                        <input type="text" id="access-code-input" required autocomplete="off" placeholder="Enter code here..." class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 outline-none text-slate-900 font-bold text-center tracking-widest uppercase focus:border-brand-500 transition-colors">
                        <p id="access-error" class="text-rose-500 text-xs font-bold mt-2 text-center hidden"><i class="ph-bold ph-warning-circle mr-1"></i>Invalid access code.</p>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="logoutUser()" class="w-1/3 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-bold transition-colors">Cancel</button>
                        <button type="submit" class="w-2/3 bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-md transition-all">Acknowledge & Enter</button>
                    </div>
                </form>
            </div>
        </div>

        <aside class="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            <div class="h-28 flex flex-col items-center justify-center border-b border-slate-100 px-4">
                <div class="group relative flex flex-col items-center cursor-help">
                    <div class="flex items-center">
                        <div class="relative drop-shadow-sm transition-transform hover:scale-105">
                            <svg viewBox="0 0 120 100" class="w-14 h-14" xmlns="http://www.w3.org/2000/svg">
                                <path d="M 20 55 C 15 80, 30 95, 60 95 C 90 95, 105 80, 100 55 C 95 30, 90 25, 80 5 L 70 30 C 65 28, 55 28, 50 30 L 40 5 C 30 25, 25 30, 20 55 Z" fill="white" stroke="#2d1b19" stroke-width="4" stroke-linejoin="round"/>
                                <path d="M 35 48 L 45 53 L 35 58 M 85 48 L 75 53 L 85 58" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M 5 50 L 25 53 M 2 60 L 23 60 M 7 70 L 26 67 M 115 50 L 95 53 M 118 60 L 97 60 M 113 70 L 94 67" fill="none" stroke="#2d1b19" stroke-width="3" stroke-linecap="round"/>
                                <path d="M 48 65 Q 54 72 60 65 Q 66 72 72 65" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/>
                                <path d="M 52 68 C 52 88, 68 88, 68 68 Z" fill="#fbcfe8" stroke="#2d1b19" stroke-width="3"/>
                                <circle cx="32" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                                <circle cx="88" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                            </svg>
                        </div>
                        <span class="text-3xl font-extrabold text-slate-900 ml-3 hidden lg:block tracking-tight">BUFT</span>
                    </div>
                    <span class="text-[9px] font-bold text-slate-400 mt-2 hidden lg:block uppercase tracking-widest text-center leading-tight">BakaNeko's Ultimate Finance Tool</span>
                    
                    <div class="absolute left-full lg:left-auto lg:top-full lg:mt-2 ml-4 lg:ml-0 w-max px-3 py-2 bg-slate-900 text-white text-[11px] font-bold rounded-lg opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-[100] shadow-xl transform scale-95 group-hover:scale-100">
                        Created by Paul Bienvenu (aka BakaNeko)
                        <div class="absolute top-1/2 -left-1 -translate-y-1/2 lg:top-auto lg:-top-1 lg:left-1/2 lg:-translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45"></div>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 mt-4 flex flex-col">
                <button onclick="switchTab('ledger')" id="nav-ledger" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl bg-brand-50 text-brand-600 font-semibold transition-all">
                    <i class="ph-bold ph-list-numbers text-2xl lg:text-xl"></i><span class="hidden lg:block">Ledger</span>
                </button>
                <button onclick="switchTab('templates')" id="nav-templates" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-semibold transition-all">
                    <i class="ph-bold ph-calendar-plus text-2xl lg:text-xl"></i><span class="hidden lg:block">Templates</span>
                </button>
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-semibold transition-all">
                    <i class="ph-bold ph-chart-polar text-2xl lg:text-xl"></i><span class="hidden lg:block">Insights</span>
                </button>
                
                <div class="mt-auto pt-4 border-t border-slate-100 space-y-2">
                    <button onclick="openModal('settings')" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-400 hover:bg-slate-50 hover:text-slate-700 font-semibold transition-all">
                        <i class="ph-bold ph-gear-six text-2xl lg:text-xl"></i><span class="hidden lg:block">Settings</span>
                    </button>
                    <button onclick="logoutUser()" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-400 hover:bg-rose-50 hover:text-rose-600 font-semibold transition-all">
                        <i class="ph-bold ph-sign-out text-2xl lg:text-xl"></i><span class="hidden lg:block">Sign Out</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Mobile Nav -->
        <div class="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-around p-2 pb-safe z-50 shadow-[0_-4px_24px_rgba(0,0,0,0.05)]">
            <button onclick="switchTab('ledger')" class="flex flex-col items-center p-2 text-brand-600"><i class="ph-bold ph-list-numbers text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Ledger</span></button>
            <button onclick="switchTab('templates')" class="flex flex-col items-center p-2 text-slate-400"><i class="ph-bold ph-calendar-plus text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Templates</span></button>
            <button onclick="switchTab('dashboard')" class="flex flex-col items-center p-2 text-slate-400"><i class="ph-bold ph-chart-polar text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Insights</span></button>
            <button onclick="openModal('settings')" class="flex flex-col items-center p-2 text-slate-400"><i class="ph-bold ph-gear-six text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Settings</span></button>
        </div>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 lg:px-8 shrink-0 z-10">
                <div class="flex items-center gap-2 lg:gap-4">
                    <div class="flex items-center bg-slate-100 rounded-full p-1 border border-slate-200 shadow-sm">
                        <button id="btn-prev-month" onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition-colors text-slate-500 hover:text-slate-900 shadow-sm disabled:opacity-30 disabled:hover:bg-transparent disabled:cursor-not-allowed"><i class="ph-bold ph-caret-left"></i></button>
                        <h2 id="current-month-display" class="text-sm lg:text-base font-bold w-32 lg:w-36 text-center text-slate-800 tracking-tight">Loading...</h2>
                        <button id="btn-next-month" onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition-colors text-slate-500 hover:text-slate-900 shadow-sm disabled:opacity-30 disabled:hover:bg-transparent disabled:cursor-not-allowed"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <button onclick="goToToday()" class="px-3.5 py-1.5 bg-brand-50 hover:bg-brand-100 text-brand-600 rounded-full text-[10px] lg:text-xs font-bold uppercase tracking-wider transition-colors shadow-sm hidden sm:block border border-brand-100">Today</button>
                </div>
                
                <div class="flex items-center gap-3 lg:gap-6">
                    <button onclick="openWashuChat()" id="btn-ask-washu" class="bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-700 hover:to-purple-700 text-white px-3 lg:px-4 py-2 rounded-full font-bold shadow-lg shadow-fuchsia-500/20 flex items-center transition-all transform hover:scale-105 text-sm hide" title="Ask Washu">
                        <i class="ph-fill ph-brain text-lg lg:mr-1.5"></i><span class="hidden lg:inline">Ask Washu</span>
                    </button>
                    <div class="flex items-center bg-slate-50 px-4 py-2 rounded-full border border-slate-200 shadow-sm gap-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mr-1 hidden md:block">Bank:</span>
                        <span class="text-slate-400 font-bold">$</span>
                        <input type="text" inputmode="decimal" autocomplete="one-time-code" data-lpignore="true" id="manual-bank-balance" class="font-extrabold text-slate-800 w-24 outline-none bg-transparent disabled:text-slate-400 disabled:cursor-not-allowed">
                        <label class="flex items-center gap-1 cursor-pointer ml-1 border-l border-slate-200 pl-2" title="Auto-carry: use previous month's end-of-month balance">
                            <input type="checkbox" id="auto-carry-checkbox" class="accent-brand-500 w-3.5 h-3.5 cursor-pointer" onchange="toggleAutoCarry(this.checked)">
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider hidden md:block">Auto</span>
                        </label>
                    </div>
                    
                    <button onclick="openTransactionModal()" class="bg-slate-900 hover:bg-brand-600 text-white p-2 lg:px-5 lg:py-2.5 rounded-full font-semibold shadow-lg shadow-slate-900/20 flex items-center transition-all transform hover:scale-105">
                        <i class="ph-bold ph-plus lg:mr-2 text-xl lg:text-base"></i> <span class="hidden lg:inline">Add Item</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 lg:p-8 pb-28 md:pb-8 scroll-smooth relative" id="main-scroll-area">
                
                <div id="data-loader" class="absolute inset-0 bg-[#f4f7f9] z-50 flex flex-col items-center justify-center">
                    <i class="ph-bold ph-spinner animate-spin text-4xl text-brand-500 mb-4"></i>
                    <span class="text-slate-500 font-bold tracking-widest uppercase text-xs">Syncing Ledger...</span>
                </div>

                <!-- LEDGER VIEW -->
                <div id="view-ledger" class="max-w-7xl mx-auto space-y-6">
                    <div id="archival-notice" class="bg-amber-50 border border-amber-200 text-amber-800 px-4 py-3 rounded-xl flex items-center hide shadow-sm">
                        <i class="ph-fill ph-lock-key text-xl mr-3"></i>
                        <span class="text-sm font-bold">Historical View: This month is in the past. Template changes will not alter these records.</span>
                    </div>

                    <div class="sticky top-0 z-20 -mx-4 lg:-mx-8 px-4 lg:px-8 pt-2 pb-4 bg-[#f4f7f9]">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                            <div class="bg-white p-4 lg:p-5 rounded-2xl border border-rose-100 shadow-sm flex flex-col justify-center relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-3 opacity-5 text-rose-300"><i class="ph-fill ph-arrow-circle-down text-5xl"></i></div>
                                <span class="text-[10px] font-bold text-rose-400 uppercase tracking-wider mb-1 z-10">Withdrawals Left</span>
                                <div id="metric-withdrawals" class="text-xl lg:text-2xl font-extrabold text-rose-600 tracking-tight z-10">$0.00</div>
                            </div>
                            <div class="bg-white p-4 lg:p-5 rounded-2xl border border-emerald-100 shadow-sm flex flex-col justify-center relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-3 opacity-5 text-emerald-300"><i class="ph-fill ph-arrow-circle-up text-5xl"></i></div>
                                <span class="text-[10px] font-bold text-emerald-500 uppercase tracking-wider mb-1 z-10">Deposits Left</span>
                                <div id="metric-deposits" class="text-xl lg:text-2xl font-extrabold text-emerald-600 tracking-tight z-10">$0.00</div>
                            </div>
                            <div class="bg-white p-4 lg:p-5 rounded-2xl border border-brand-100 shadow-sm flex flex-col justify-center relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-3 opacity-5 text-brand-300"><i class="ph-fill ph-scales text-5xl"></i></div>
                                <span class="text-[10px] font-bold text-brand-500 uppercase tracking-wider mb-1 z-10">Overall Delta</span>
                                <div id="metric-delta" class="text-xl lg:text-2xl font-extrabold text-slate-900 tracking-tight z-10">$0.00</div>
                            </div>
                            <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-4 lg:p-5 rounded-2xl shadow-lg shadow-slate-900/20 flex flex-col justify-center relative overflow-hidden text-white">
                                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                                <div class="absolute top-0 right-0 p-3 opacity-10"><i class="ph-fill ph-bank text-5xl"></i></div>
                                <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wider mb-1 z-10">Projected EOM</span>
                                <div id="metric-projected" class="text-xl lg:text-2xl font-extrabold tracking-tight z-10 text-emerald-400">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-slate-50/50 border-b border-slate-200 text-[11px] font-bold uppercase text-slate-400 tracking-wider">
                                        <th class="py-4 px-6 w-24">Date</th>
                                        <th class="py-4 px-6">Item</th>
                                        <th class="py-4 px-6">Category</th>
                                        <th class="py-4 px-6 text-right">Amount</th>
                                        <th class="py-4 px-6 text-center w-40">Status</th>
                                        <th class="py-4 px-6 text-right w-36 bg-ledger-highlight/50 text-slate-500">Running Total</th>
                                        <th class="py-4 px-4 text-center w-24"></th>
                                    </tr>
                                </thead>
                                <tbody id="ledger-body" class="text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TEMPLATES VIEW -->
                <div id="view-templates" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-3xl border border-slate-200 shadow-sm gap-4">
                        <div>
                            <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Recurring</h2>
                            <p class="text-slate-500 text-sm mt-1">Changes here affect current and future months. Past months are locked.</p>
                        </div>
                        <div class="flex items-center space-x-4 w-full md:w-auto">
                            <div class="bg-slate-100 p-1 rounded-xl flex">
                                <button onclick="setTemplateView('category')" id="btn-view-cat" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-brand-600 shadow-sm transition-all">By Category</button>
                                <button onclick="setTemplateView('recurrence')" id="btn-view-rec" class="px-3 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">By Recurrence</button>
                            </div>
                            <button onclick="refreshLedgerFromTemplates()" class="flex-1 md:flex-none justify-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2.5 rounded-xl font-bold flex items-center transition-all border border-slate-200" title="Re-sync all templates to the current month's ledger">
                                <i class="ph-bold ph-arrows-clockwise mr-2"></i> Refresh Ledger
                            </button>
                            <button onclick="openTemplateModal()" class="flex-1 md:flex-none justify-center bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-brand-500/30 flex items-center transition-all">
                                <i class="ph-bold ph-plus mr-2"></i> New
                            </button>
                        </div>
                    </div>
                    <div id="templates-container" class="space-y-8"></div>
                </div>

                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Monthly Insights</h2>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-trend-up text-brand-500 mr-2 text-xl"></i> Running Impact Trend</h3>
                        <div class="relative h-64 w-full"><canvas id="balanceTrendChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-calendar-dots text-brand-500 mr-2 text-xl"></i> Year Overview <span id="yearOverviewLabel" class="ml-2 text-sm font-semibold text-slate-400"></span></h3>
                        <div class="relative h-80 w-full"><canvas id="yearOverviewChart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-scales text-brand-500 mr-2 text-xl"></i> Cash Flow</h3>
                            <div class="relative h-64 w-full"><canvas id="cashflowChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-chart-pie-slice text-brand-500 mr-2 text-xl"></i> Withdrawals by Category</h3>
                            <div class="relative h-64 w-full flex justify-center"><canvas id="categoryChart"></canvas></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-transaction" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-extrabold text-lg text-slate-800">Ledger Entry</h3>
                <button onclick="closeModal('transaction')" class="text-slate-400 hover:text-slate-700 bg-white hover:bg-slate-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <form id="form-transaction" onsubmit="handleTransactionSubmit(event)" class="p-6 space-y-4">
                <input type="hidden" id="txn-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Date</label>
                        <input type="date" id="txn-date" required class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-medium bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Type</label>
                        <select id="txn-type" onchange="updateCategoryOptions('txn-category', this.value)" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-bold bg-white cursor-pointer shadow-sm">
                            <option value="withdrawal">Withdrawal (-)</option>
                            <option value="deposit">Deposit (+)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Description</label>
                    <input type="text" id="txn-name" required placeholder="e.g., Target Run" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 shadow-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Amount ($)</label>
                        <input type="number" step="0.01" id="txn-amount" required class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-bold shadow-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Category</label>
                        <select id="txn-category" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 bg-white shadow-sm cursor-pointer"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Comment (Optional)</label>
                    <input type="text" id="txn-comment" placeholder="e.g., cleared temporarily" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 shadow-sm text-sm">
                </div>
                <div class="pt-4 flex justify-end space-x-3 border-t border-slate-100 mt-2">
                    <button type="button" onclick="closeModal('transaction')" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-slate-900 hover:bg-brand-600 text-white rounded-xl font-bold shadow-md">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Restored Comment Edit Modal -->
    <div id="modal-comment" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[110] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-brand-50">
                <h3 class="font-extrabold text-lg text-brand-900"><i class="ph-fill ph-chat-text mr-2 text-brand-600"></i>Line Comment</h3>
                <button onclick="closeModal('comment')" class="text-brand-400 hover:text-brand-700 bg-white hover:bg-brand-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="p-6">
                <input type="hidden" id="edit-comment-id">
                <textarea id="edit-comment-text" rows="3" class="w-full border border-slate-200 rounded-xl p-4 outline-none text-slate-700 shadow-sm focus:ring-2 focus:ring-brand-500 mb-4" placeholder="Add your freehand notes here..."></textarea>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('comment')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-xl font-bold">Cancel</button>
                    <button type="button" onclick="saveLedgerComment()" class="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-bold shadow-md">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restored Full Fidelity Template Modal -->
    <div id="modal-template" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                <h3 class="font-extrabold text-lg text-slate-800" id="tpl-modal-title">New Template</h3>
                <button onclick="closeModal('template')" class="text-slate-400 hover:text-slate-700 bg-white hover:bg-slate-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <form id="form-template" onsubmit="handleTemplateSubmit(event)" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="tpl-id">
                <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <div>
                        <span class="block text-sm font-bold text-slate-800">Auto-Processing</span>
                        <span class="block text-[11px] font-medium text-slate-500 mt-0.5">Automatically clears when date passes</span>
                    </div>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="tpl-autoprocess" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="tpl-autoprocess" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Template Name</label>
                    <input type="text" id="tpl-name" required placeholder="e.g., Netflix" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-medium shadow-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Type</label>
                        <select id="tpl-type" onchange="updateCategoryOptions('tpl-category', this.value)" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-bold bg-white shadow-sm cursor-pointer">
                            <option value="withdrawal">Withdrawal (-)</option>
                            <option value="deposit">Deposit (+)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Amount ($)</label>
                        <input type="number" step="0.01" id="tpl-amount" required class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-bold shadow-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Category</label>
                    <select id="tpl-category" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-medium bg-white shadow-sm cursor-pointer"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Details / Notes</label>
                    <textarea id="tpl-details" rows="2" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-slate-700 shadow-sm text-sm"></textarea>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-3">Recurrence Pattern</label>
                    <select id="tpl-frequency" onchange="toggleFrequencyUI()" class="w-full border border-slate-200 rounded-xl px-4 py-2 mb-4 outline-none text-slate-700 font-bold bg-slate-50 cursor-pointer">
                        <option value="monthly">Monthly (Dates of Month)</option>
                        <option value="biweekly">Bi-Weekly (Every 2 Weeks)</option>
                        <option value="weekly">Weekly (Days of Week)</option>
                        <option value="custom">Specific Dates (Yearly)</option>
                    </select>
                    <div id="tpl-ui-monthly" class="transition-all">
                        <label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Select Dates</label>
                        <div class="grid grid-cols-7 gap-1.5" id="tpl-monthly-grid"></div>
                    </div>
                    <div id="tpl-ui-biweekly" class="hide transition-all">
                        <label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Anchor Date (first occurrence)</label>
                        <input type="date" id="tpl-anchor-date" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-medium bg-slate-50">
                        <p class="text-[10px] text-slate-400 mt-2">Pick any date this item occurs. Every 14 days will be calculated from it.</p>
                    </div>
                    <div id="tpl-ui-weekly" class="hide transition-all">
                        <label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Select Days</label>
                        <div class="flex justify-between" id="tpl-weekly-days"></div>
                    </div>
                    <div id="tpl-ui-custom" class="hide transition-all">
                        <label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Add Dates (MM/DD)</label>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="tpl-custom-mm" placeholder="MM" class="w-20 border border-slate-200 rounded-xl px-3 py-2 text-center outline-none bg-slate-50">
                            <span class="text-slate-400 font-bold self-center">/</span>
                            <input type="number" id="tpl-custom-dd" placeholder="DD" class="w-20 border border-slate-200 rounded-xl px-3 py-2 text-center outline-none bg-slate-50">
                            <button type="button" onclick="addCustomDateToDraft()" class="bg-slate-800 text-white px-4 rounded-xl font-bold">Add</button>
                        </div>
                        <div id="draft-custom-dates" class="flex flex-wrap gap-2 mt-3"></div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 border-t border-slate-100 shrink-0">
                    <button type="button" onclick="closeModal('template')" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-slate-900 hover:bg-brand-600 text-white rounded-xl font-bold shadow-md" id="tpl-save-btn">Save Recurring</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300 max-h-[85vh] flex flex-col">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                <h3 class="font-extrabold text-lg text-slate-800"><i class="ph-bold ph-gear-six mr-2 text-slate-500"></i>Settings</h3>
                <button onclick="closeModal('settings')" class="text-slate-400 hover:text-slate-700 bg-white hover:bg-slate-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto flex-1">
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-slate-800 mb-1 flex items-center"><i class="ph-bold ph-download-simple mr-2 text-brand-500"></i>Export Data</h4>
                    <p class="text-xs text-slate-500 mb-4">Download all your templates, transactions, and settings as a JSON backup file.</p>
                    <button onclick="exportData()" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-md transition-all flex items-center justify-center">
                        <i class="ph-bold ph-file-arrow-down mr-2 text-lg"></i> Export Backup
                    </button>
                </div>
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-slate-800 mb-1 flex items-center"><i class="ph-bold ph-brain mr-2 text-fuchsia-500"></i>Ask Washu (AI)</h4>
                    <p class="text-xs text-slate-500 mb-4">Connect an AI provider to enable the Washu assistant.</p>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Provider</label>
                            <select id="settings-washu-provider" onchange="onWashuProviderChange()" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 text-sm shadow-sm focus:ring-2 focus:ring-fuchsia-400 bg-white">
                                <option value="gemini">Google Gemini</option>
                                <option value="openai-compatible">OpenAI-Compatible (Ollama, LM Studio, etc.)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Endpoint URL</label>
                            <input type="text" id="settings-washu-endpoint" placeholder="https://generativelanguage.googleapis.com/v1beta" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-mono text-sm shadow-sm focus:ring-2 focus:ring-fuchsia-400">
                            <p id="washu-endpoint-hint" class="text-[10px] text-slate-400 mt-1">Default endpoint is pre-filled. Edit only if needed.</p>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Model</label>
                            <input type="text" id="settings-washu-model" placeholder="gemini-2.0-flash" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-mono text-sm shadow-sm focus:ring-2 focus:ring-fuchsia-400">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 flex items-center">
                                API Key
                                <span id="washu-key-required" class="ml-1.5 text-rose-400">(required)</span>
                            </label>
                            <input type="password" id="settings-washu-key" placeholder="AIza..." class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 font-mono text-sm shadow-sm focus:ring-2 focus:ring-fuchsia-400">
                            <p id="washu-key-hint" class="text-[10px] text-slate-400 mt-1">Get a key at <a href="https://aistudio.google.com/apikey" target="_blank" class="font-bold text-brand-600 hover:underline">aistudio.google.com</a></p>
                        </div>
                        <div id="washu-mixed-content-warning" class="bg-amber-50 border border-amber-200 rounded-xl px-3 py-2 hidden">
                            <p class="text-[11px] font-bold text-amber-700 flex items-center"><i class="ph-fill ph-warning mr-1.5"></i>Your browser may block http:// requests from this https:// page. Use HTTPS for the endpoint or access BUFT over HTTP.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="testWashuConnection()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-2.5 rounded-xl font-bold transition-all text-sm flex items-center justify-center">
                                <i class="ph-bold ph-plugs-connected mr-1.5"></i> Test
                            </button>
                            <button onclick="saveWashuProvider()" class="flex-1 bg-fuchsia-600 hover:bg-fuchsia-700 text-white py-2.5 rounded-xl font-bold shadow-md transition-all text-sm">Save</button>
                        </div>
                    </div>
                    <p id="washu-provider-status" class="text-[11px] font-bold mt-2 text-slate-400"></p>
                </div>
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-slate-800 mb-1 flex items-center"><i class="ph-bold ph-upload-simple mr-2 text-amber-500"></i>Import Data</h4>
                    <p class="text-xs text-slate-500 mb-2">Restore from a previously exported backup file.</p>
                    <div class="bg-rose-50 border border-rose-200 rounded-xl px-3 py-2 mb-4">
                        <p class="text-[11px] font-bold text-rose-700 flex items-center"><i class="ph-fill ph-warning mr-1.5"></i>This will wipe all existing data and replace it with the backup.</p>
                    </div>
                    <label class="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold shadow-md transition-all flex items-center justify-center cursor-pointer">
                        <i class="ph-bold ph-file-arrow-up mr-2 text-lg"></i> Choose Backup File
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                    <div id="import-status" class="mt-3 text-center text-sm font-bold hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Washu AI Chat Modal -->
    <div id="modal-washu" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 transition-transform duration-300 max-h-[85vh] flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-fuchsia-50 to-purple-50 shrink-0">
                <div class="flex items-center">
                    <div class="bg-gradient-to-br from-fuchsia-500 to-purple-600 p-2 rounded-xl mr-3 shadow-md shadow-fuchsia-500/20">
                        <i class="ph-fill ph-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-slate-800 text-base">Ask Washu</h3>
                        <p class="text-[10px] font-bold text-fuchsia-500 uppercase tracking-widest">Bienvenu Family AI</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="washu-api-timer" class="text-[10px] font-bold text-slate-400 bg-white px-2.5 py-1 rounded-full border border-slate-200 hidden whitespace-nowrap"><i class="ph-bold ph-clock mr-1"></i><span id="washu-timer-text"></span></span>
                    <button onclick="clearWashuChat()" class="text-slate-400 hover:text-fuchsia-600 bg-white hover:bg-fuchsia-50 rounded-full p-1.5 transition-colors" title="New conversation"><i class="ph-bold ph-arrow-counter-clockwise text-lg"></i></button>
                    <button onclick="closeModal('washu')" class="text-slate-400 hover:text-slate-700 bg-white hover:bg-slate-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
            </div>
            <div id="washu-messages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-[300px]">
                <div class="flex gap-3">
                    <div class="bg-gradient-to-br from-fuchsia-500 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 shadow-md">
                        <i class="ph-fill ph-brain text-white text-sm"></i>
                    </div>
                    <div class="bg-slate-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-[85%] border border-slate-100">
                        <p class="text-sm text-slate-700 leading-relaxed">Hey there! I'm <strong>Washu</strong>, the Bienvenu Family AI â€” greatest genius in the universe, naturally. ðŸ˜</p>
                        <p class="text-sm text-slate-700 leading-relaxed mt-2">Ask me anything about your finances. I can see all your BUFT data across every month.</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 ml-11">
                    <button onclick="askWashuQuick('What\\'s my biggest expense this month?')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Biggest expense?</button>
                    <button onclick="askWashuQuick('Am I on track to end the month positive?')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Am I on track?</button>
                    <button onclick="askWashuQuick('Summarize my financial situation across all months.')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Full summary</button>
                </div>
            </div>
            <div class="px-4 py-3 border-t border-slate-100 bg-slate-50/50 shrink-0">
                <form onsubmit="handleWashuSubmit(event)" class="flex gap-2">
                    <input type="text" id="washu-input" placeholder="Ask Washu anything..." class="flex-1 border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-slate-700 text-sm shadow-sm focus:ring-2 focus:ring-fuchsia-400 focus:border-fuchsia-400" autocomplete="off">
                    <button type="submit" id="washu-send-btn" class="bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-700 hover:to-purple-700 text-white px-4 py-2.5 rounded-xl font-bold shadow-md transition-all flex items-center">
                        <i class="ph-bold ph-paper-plane-tilt"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- FIREBASE CLOUD ENGINE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCkZHoWGByIZXzFSGjrZMHgEytwdqyZLqE",
            authDomain: "buft-b0d7f.firebaseapp.com",
            projectId: "buft-b0d7f",
            storageBucket: "buft-b0d7f.firebasestorage.app",
            messagingSenderId: "724127677004",
            appId: "1:724127677004:web:080d212affb3cb87ccd2e9",
            measurementId: "G-NDCGFDJEGC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- CRITICAL IPAD STABILITY FIX: Forced Long Polling ---
        // This stops the WebSocket connection from hanging on Safari and Edge for iPad.
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        let currentUser = null;
        let dataLoaded = { settings: false, txns: false, tpls: false };
        let hasInitializedCore = false;

        const REAL_CURRENT_DATE = new Date(); 
        const WINDOW_START = new Date(2025, 0, 1);
        const WINDOW_END = new Date(2026, 11, 31);

        window.state = {
            currentDate: new Date(REAL_CURRENT_DATE),
            monthlyBalances: {},
            templateViewMode: 'category',
            initializedMonths: [],
            transactions: [],
            templates: [],
            hasAcceptedTerms: false,
            pastRowsCollapsed: true
        };

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('hide');
                    document.getElementById('main-app').classList.remove('hide');
                    setTimeout(() => document.getElementById('main-app').classList.remove('opacity-0'), 50);
                }, 500);
                setupCloudSync();
            } else {
                currentUser = null;
                document.getElementById('main-app').classList.add('hide');
                document.getElementById('main-app').classList.add('opacity-0');
                const overlay = document.getElementById('login-overlay');
                overlay.classList.remove('hide');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            }
        });

        window.loginWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert("Login Error: " + err.message));
        };

        window.logoutUser = () => signOut(auth).then(() => location.reload());

        // --- CLOUD SYNC ENGINE ---
        async function setupCloudSync() {
            const uid = currentUser.uid;
            const settingsRef = doc(db, 'users', uid, 'settings', 'main');

            // Safety timeout: if data hasn't loaded in 15 seconds, force-hide the loader
            // so the user isn't stuck forever on iPad
            const safetyTimer = setTimeout(() => {
                console.warn("BUFT: Safety timeout hit - forcing loader off");
                const loader = document.getElementById('data-loader');
                if (loader && !loader.classList.contains('hide')) {
                    loader.classList.add('hide');
                }
            }, 15000);

            // --- SELF-HEALING: Check for existence immediately to prevent the "Syncing" loop ---
            try {
                const snap = await getDoc(settingsRef);
                if (!snap.exists()) {
                    // Start fresh if user doc doesn't exist (e.g. after a purge)
                    await setDoc(settingsRef, { monthlyBalances: {}, initializedMonths: [], hasAcceptedTerms: false });
                }

                onSnapshot(settingsRef, (docSnap) => {
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        // Migration: old single bankBalance â†’ per-month format
                        if (data.monthlyBalances) {
                            state.monthlyBalances = data.monthlyBalances;
                        } else if (typeof data.bankBalance === 'number') {
                            const currentKey = getMonthKey(REAL_CURRENT_DATE.getFullYear(), REAL_CURRENT_DATE.getMonth());
                            state.monthlyBalances = { [currentKey]: { amount: data.bankBalance, autoCarry: false } };
                            // Persist migrated format back to Firestore
                            setDoc(settingsRef, { monthlyBalances: state.monthlyBalances }, { merge: true });
                        } else {
                            state.monthlyBalances = {};
                        }
                        state.initializedMonths = data.initializedMonths || [];
                        state.hasAcceptedTerms = data.hasAcceptedTerms || false;
                        // Load Washu AI provider config (try-catch to never block init)
                        try { loadWashuProviderFromSettings(data); } catch(e) { console.error('Washu config load error:', e); }
                    }
                    dataLoaded.settings = true;
                    checkReadyToInit(safetyTimer);
                }, (err) => console.error("Database connection error:", err));

                onSnapshot(collection(db, 'users', uid, 'templates'), (snapshot) => {
                    let tpls = [];
                    snapshot.forEach(d => tpls.push(d.data()));
                    state.templates = tpls;
                    dataLoaded.tpls = true;
                    checkReadyToInit(safetyTimer);
                });

                onSnapshot(collection(db, 'users', uid, 'transactions'), (snapshot) => {
                    let txns = [];
                    snapshot.forEach(d => txns.push(d.data()));
                    state.transactions = txns;
                    dataLoaded.txns = true;
                    checkReadyToInit(safetyTimer);
                });
            } catch (err) {
                console.error("Initial Cloud Connection Failure:", err);
                clearTimeout(safetyTimer);
                // Force-hide loader on connection failure so user isn't stuck
                document.getElementById('data-loader').classList.add('hide');
            }
        }

        async function checkReadyToInit(safetyTimer) {
            if (!(dataLoaded.settings && dataLoaded.txns && dataLoaded.tpls)) return;

            if (!hasInitializedCore) {
                // THE BOUNCER CHECK
                if (!state.hasAcceptedTerms) {
                    document.getElementById('data-loader').classList.add('hide');
                    const gate = document.getElementById('access-gate-overlay');
                    gate.classList.remove('hide');
                    setTimeout(() => gate.classList.remove('opacity-0'), 10);
                    return;
                }
                hasInitializedCore = true;
                if (safetyTimer) clearTimeout(safetyTimer);
                document.getElementById('data-loader').classList.add('hide');
                const gate = document.getElementById('access-gate-overlay');
                gate.classList.add('opacity-0');
                setTimeout(() => { gate.classList.add('hide'); }, 300);
                try {
                    await initializeMonth(state.currentDate.getFullYear(), state.currentDate.getMonth());
                    await processAutoClear();
                } catch(e) { console.error("Init month error:", e); }
                renderApp();
                scrollToTodayDivider();
            } else {
                renderApp();
            }
        }

        window.verifyAccessCode = async (e) => {
            e.preventDefault();
            const code = document.getElementById('access-code-input').value.trim().toUpperCase();
            if (code === 'L337') {
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { hasAcceptedTerms: true }, { merge: true });
                state.hasAcceptedTerms = true;
                // Proceed past bouncer â€” hide the gate and initialize
                hasInitializedCore = true;
                const gate = document.getElementById('access-gate-overlay');
                gate.classList.add('opacity-0');
                setTimeout(() => { gate.classList.add('hide'); }, 300);
                document.getElementById('data-loader').classList.add('hide');
                try {
                    await initializeMonth(state.currentDate.getFullYear(), state.currentDate.getMonth());
                    await processAutoClear();
                } catch(e) { console.error("Init after verify error:", e); }
                renderApp();
                scrollToTodayDivider();
            } else {
                document.getElementById('access-error').classList.remove('hidden');
            }
        }

        // --- RESTORED FEATURE: Category Configs ---
        window.categoryConfig = {
            withdrawal: [
                { name: 'Home', color: 'bg-indigo-100 text-indigo-700' },
                { name: 'Services', color: 'bg-lime-100 text-lime-800' },
                { name: 'Subscription', color: 'bg-purple-100 text-purple-700' },
                { name: 'Auto', color: 'bg-orange-100 text-orange-700' },
                { name: 'CreditCards', color: 'bg-rose-100 text-rose-700' },
                { name: 'Utility', color: 'bg-cyan-100 text-cyan-700' },
                { name: 'Entertainment', color: 'bg-pink-100 text-pink-700' },
                { name: 'Groceries', color: 'bg-emerald-100 text-emerald-700' },
                { name: 'Other', color: 'bg-slate-100 text-slate-700' }
            ],
            deposit: [
                { name: 'Direct Deposit', color: 'bg-emerald-100 text-emerald-800' },
                { name: 'Adjustment', color: 'bg-blue-100 text-blue-800' },
                { name: 'Other Deposit', color: 'bg-teal-100 text-teal-800' }
            ]
        };
        const daysOfWeek = [ { id: 0, label: 'S' }, { id: 1, label: 'M' }, { id: 2, label: 'T' }, { id: 3, label: 'W' }, { id: 4, label: 'T' }, { id: 5, label: 'F' }, { id: 6, label: 'S' } ];

        let tempCustomDates = []; 
        let cashflowChartObj = null; let categoryChartObj = null; let balanceTrendChartObj = null; let yearOverviewChartObj = null;

        function getCatColorClass(type, catName) {
            const list = categoryConfig[type] || [];
            const found = list.find(c => c.name === catName);
            return found ? found.color : 'bg-slate-100 text-slate-700';
        }

        window.renderApp = function() {
            updateHeader();
            renderLedger();
            if(!document.getElementById('view-templates').classList.contains('hide')) renderTemplates();
            if(!document.getElementById('view-dashboard').classList.contains('hide')) renderDashboard();
        }

        function updateHeader() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-display').innerText = `${monthNames[state.currentDate.getMonth()]} ${state.currentDate.getFullYear()}`;

            const key = getCurrentMonthKey();
            const entry = getMonthBalanceEntry(key);
            const balanceInput = document.getElementById('manual-bank-balance');
            const autoCarryCb = document.getElementById('auto-carry-checkbox');

            if (entry.autoCarry) {
                const carried = resolveAutoCarryBalance(key);
                balanceInput.value = carried.toFixed(2);
                balanceInput.disabled = true;
                autoCarryCb.checked = true;
            } else {
                balanceInput.value = entry.amount.toFixed(2);
                balanceInput.disabled = false;
                autoCarryCb.checked = false;
            }

            const btnPrev = document.getElementById('btn-prev-month');
            const btnNext = document.getElementById('btn-next-month');
            let prevTest = new Date(state.currentDate); prevTest.setMonth(prevTest.getMonth() - 1);
            btnPrev.disabled = prevTest < WINDOW_START;
            let nextTest = new Date(state.currentDate); nextTest.setMonth(nextTest.getMonth() + 1);
            btnNext.disabled = nextTest > WINDOW_END;

            const isPastMonth = state.currentDate.getFullYear() < REAL_CURRENT_DATE.getFullYear() || (state.currentDate.getFullYear() === REAL_CURRENT_DATE.getFullYear() && state.currentDate.getMonth() < REAL_CURRENT_DATE.getMonth());
            if(isPastMonth) document.getElementById('archival-notice').classList.remove('hide');
            else document.getElementById('archival-notice').classList.add('hide');
        }

        window.togglePastRows = function() {
            state.pastRowsCollapsed = !state.pastRowsCollapsed;
            const allRows = document.querySelectorAll('.past-ledger-row');
            const unclearedRows = document.querySelectorAll('.past-ledger-row.past-uncleared');
            const clearedCount = allRows.length - unclearedRows.length;
            const icon = document.getElementById('past-toggle-icon');
            const label = document.getElementById('past-toggle-label');
            if (state.pastRowsCollapsed) {
                allRows.forEach(r => { r.style.display = r.classList.contains('past-uncleared') ? '' : 'none'; });
                if (icon) icon.className = 'ph-fill ph-caret-right mr-1.5';
                if (label) label.textContent = pastCollapseLabel(true, allRows.length, clearedCount, unclearedRows.length);
            } else {
                allRows.forEach(r => r.style.display = '');
                if (icon) icon.className = 'ph-fill ph-caret-down mr-1.5';
                if (label) label.textContent = pastCollapseLabel(false, allRows.length, clearedCount, unclearedRows.length);
            }
        }

        function pastCollapseLabel(collapsed, total, cleared, uncleared) {
            if (collapsed) {
                let txt = `(${cleared} cleared hidden`;
                if (uncleared > 0) txt += ` Â· ${uncleared} uncleared`;
                return txt + ')';
            }
            return `(${total} past item${total !== 1 ? 's' : ''} shown)`;
        }

        window.scrollToTodayDivider = function() {
            setTimeout(() => {
                const divider = document.getElementById('today-divider');
                if (divider) divider.scrollIntoView({ behavior: 'smooth', block: 'center' });
                else { const scrollArea = document.getElementById('main-scroll-area'); if(scrollArea) scrollArea.scrollTop = 0; }
            }, 100);
        }

        window.changeMonth = async function(delta) {
            state.currentDate.setMonth(state.currentDate.getMonth() + delta);
            await initializeMonth(state.currentDate.getFullYear(), state.currentDate.getMonth());
            renderApp();
            if(state.currentDate.getMonth() === REAL_CURRENT_DATE.getMonth() && state.currentDate.getFullYear() === REAL_CURRENT_DATE.getFullYear()) scrollToTodayDivider();
            else document.getElementById('main-scroll-area').scrollTop = 0;
        }

        window.goToToday = async function() {
            state.currentDate = new Date(REAL_CURRENT_DATE);
            await initializeMonth(state.currentDate.getFullYear(), state.currentDate.getMonth());
            window.switchTab('ledger');
            renderApp();
            scrollToTodayDivider();
        }

        function getCurrentMonthKey() {
            return getMonthKey(state.currentDate.getFullYear(), state.currentDate.getMonth());
        }

        function getMonthBalanceEntry(monthKey) {
            return state.monthlyBalances[monthKey] || { amount: 0, autoCarry: false };
        }

        function getNetDeltaForMonth(monthKey) {
            const [year, month] = monthKey.split('-').map(Number);
            const txns = state.transactions.filter(t => {
                const d = new Date(t.date + 'T00:00:00');
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });
            let delta = 0;
            txns.forEach(t => {
                if (t.status !== 'cleared') {
                    delta += t.type === 'deposit' ? t.amount : -t.amount;
                }
            });
            return delta;
        }

        function getPrevMonthKey(monthKey) {
            const [year, month] = monthKey.split('-').map(Number);
            const d = new Date(year, month - 2, 1);
            return getMonthKey(d.getFullYear(), d.getMonth());
        }

        function resolveAutoCarryBalance(monthKey, visited) {
            if (!visited) visited = new Set();
            if (visited.has(monthKey)) return 0;
            visited.add(monthKey);

            const entry = getMonthBalanceEntry(monthKey);
            if (!entry.autoCarry) return entry.amount;

            // Auto-carry = previous month's Projected EoM
            // i.e. prev bank balance + prev non-cleared delta
            // (cleared items are already reflected in the bank balance)
            const prevKey = getPrevMonthKey(monthKey);
            const prevStarting = resolveAutoCarryBalance(prevKey, visited);

            const [year, month] = prevKey.split('-').map(Number);
            const prevTxns = state.transactions.filter(t => {
                const d = new Date(t.date + 'T00:00:00');
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });
            let prevDelta = 0;
            prevTxns.forEach(t => {
                if (t.status !== 'cleared') {
                    prevDelta += t.type === 'deposit' ? t.amount : -t.amount;
                }
            });

            return prevStarting + prevDelta;
        }

        function getBankBalanceForCurrentMonth() {
            return resolveAutoCarryBalance(getCurrentMonthKey());
        }

        window.updateBankBalance = function(val) {
            const num = parseFloat(val);
            if (isNaN(num)) return;
            const key = getCurrentMonthKey();
            const current = state.monthlyBalances[key];
            if (current && current.amount === num) return;
            state.monthlyBalances[key] = { amount: num, autoCarry: false };
            const cb = document.getElementById('auto-carry-checkbox');
            if (cb) cb.checked = false;
            setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { monthlyBalances: state.monthlyBalances }, { merge: true });
        }

        // Explicit bank balance save â€” Enter key or blur (not onchange which Edge fires spuriously)
        document.addEventListener('DOMContentLoaded', () => {
            const bi = document.getElementById('manual-bank-balance');
            bi.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.target.blur(); } });
            bi.addEventListener('blur', () => { updateBankBalance(bi.value); });
        });

        window.toggleAutoCarry = function(checked) {
            const key = getCurrentMonthKey();
            const entry = getMonthBalanceEntry(key);
            if (checked) {
                const carried = resolveAutoCarryBalance(key);
                state.monthlyBalances[key] = { amount: carried, autoCarry: true };
                document.getElementById('manual-bank-balance').value = carried.toFixed(2);
                document.getElementById('manual-bank-balance').disabled = true;
            } else {
                state.monthlyBalances[key] = { amount: entry.amount, autoCarry: false };
                document.getElementById('manual-bank-balance').disabled = false;
            }
            setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { monthlyBalances: state.monthlyBalances }, { merge: true });
        }

        // --- ASYNC CLOUD LOGIC: Auto-injector ---
        function getMonthKey(year, monthIndex) { return `${year}-${(monthIndex + 1).toString().padStart(2, '0')}`; }

        function getTemplateDatesForMonth(tpl, year, monthIndex) {
            const monthStr = (monthIndex + 1).toString().padStart(2, '0');
            let dates = [];
            if (tpl.frequency === 'monthly' && Array.isArray(tpl.monthlyDays)) {
                tpl.monthlyDays.forEach(day => {
                    const d = Math.min(day, new Date(year, monthIndex + 1, 0).getDate());
                    dates.push(`${year}-${monthStr}-${d.toString().padStart(2, '0')}`);
                });
            } else if (tpl.frequency === 'weekly' && Array.isArray(tpl.weeklyDays)) {
                let date = new Date(year, monthIndex, 1);
                while (date.getMonth() === monthIndex) {
                    if (tpl.weeklyDays.includes(date.getDay())) dates.push(`${year}-${monthStr}-${date.getDate().toString().padStart(2, '0')}`);
                    date.setDate(date.getDate() + 1);
                }
            } else if (tpl.frequency === 'biweekly' && tpl.anchorDate) {
                const anchor = new Date(tpl.anchorDate + 'T00:00:00');
                const firstOfMonth = new Date(year, monthIndex, 1);
                const lastOfMonth = new Date(year, monthIndex + 1, 0);
                const msPerDay = 86400000;
                const diffDays = Math.round((firstOfMonth - anchor) / msPerDay);
                const mod = ((diffDays % 14) + 14) % 14;
                const startOffset = mod === 0 ? 0 : 14 - mod;
                let d = new Date(firstOfMonth);
                d.setDate(d.getDate() + startOffset);
                while (d <= lastOfMonth) {
                    dates.push(`${year}-${monthStr}-${d.getDate().toString().padStart(2, '0')}`);
                    d.setDate(d.getDate() + 14);
                }
            } else if (tpl.frequency === 'custom' && Array.isArray(tpl.customDates)) {
                tpl.customDates.forEach(cd => {
                    const [m, d] = cd.split('/');
                    if (parseInt(m) === monthIndex + 1) dates.push(`${year}-${monthStr}-${d.padStart(2, '0')}`);
                });
            }
            return dates;
        }

        async function initializeMonth(year, monthIndex) {
            const monthKey = getMonthKey(year, monthIndex);
            if (state.initializedMonths.includes(monthKey)) return;

            state.initializedMonths.push(monthKey);
            const batch = writeBatch(db);
            batch.set(doc(db, 'users', currentUser.uid, 'settings', 'main'), { initializedMonths: state.initializedMonths }, { merge: true });

            state.templates.forEach(tpl => {
                getTemplateDatesForMonth(tpl, year, monthIndex).forEach(dateStr => {
                    const id = `tplgen_${tpl.id}_${dateStr}_${Math.random().toString(36).substr(2, 5)}`;
                    const txn = { id, templateId: tpl.id, date: dateStr, name: tpl.name, amount: tpl.amount, type: tpl.type, category: tpl.category, status: 'unprocessed', autoProcess: tpl.autoProcess || false, comment: '' };
                    batch.set(doc(db, 'users', currentUser.uid, 'transactions', id), txn);
                });
            });
            await batch.commit();
        }


        async function processAutoClear() {
            const todayStr = REAL_CURRENT_DATE.toISOString().split('T')[0];
            const batch = writeBatch(db);
            let needsCommit = false;

            state.transactions.forEach(t => {
                if (t.autoProcess && t.status === 'unprocessed' && t.date <= todayStr) {
                    batch.update(doc(db, 'users', currentUser.uid, 'transactions', t.id), { status: 'cleared' });
                    needsCommit = true;
                }
            });
            if(needsCommit) await batch.commit();
        }

        // --- LEDGER ---
        // Helper: current month key for past-month protection
        const CURRENT_MONTH_KEY = getMonthKey(REAL_CURRENT_DATE.getFullYear(), REAL_CURRENT_DATE.getMonth());

        function renderLedger() {
            const tbody = document.getElementById('ledger-body');
            tbody.innerHTML = '';

            const txns = getMonthlyTransactions();
            let runningTotal = 0; let remainingWithdrawals = 0; let remainingDeposits = 0;
            const todayStr = REAL_CURRENT_DATE.toISOString().split('T')[0];
            const viewingMonthKey = getMonthKey(state.currentDate.getFullYear(), state.currentDate.getMonth());
            const isViewingPastMonth = viewingMonthKey < CURRENT_MONTH_KEY;

            if(txns.length === 0) tbody.innerHTML = `<tr><td colspan="7" class="py-12 text-center text-slate-400 font-medium italic">No entries for this month. Templates will populate on first view.</td></tr>`;

            let dividerDrawn = false;
            const pastRows = [];
            const pastItemCount = txns.filter(t => t.date < todayStr).length;
            const pastUnclearedCount = txns.filter(t => t.date < todayStr && t.status !== 'cleared').length;
            const pastClearedCount = pastItemCount - pastUnclearedCount;

            txns.forEach((txn) => {
                if (!dividerDrawn && txn.date >= todayStr) {
                    if (pastItemCount > 0) {
                        // Insert the collapsible toggle bar
                        const toggleTr = document.createElement('tr');
                        toggleTr.id = 'today-divider';
                        toggleTr.className = 'bg-yellow-100/50 border-y-2 border-yellow-400 cursor-pointer select-none';
                        toggleTr.onclick = () => window.togglePastRows();
                        const collapsed = state.pastRowsCollapsed !== false;
                        toggleTr.innerHTML = `<td colspan="7" class="py-2.5 px-6 text-center shadow-sm"><span class="text-[11px] font-extrabold uppercase tracking-widest text-yellow-800 flex items-center justify-center"><i class="ph-fill ph-caret-${collapsed ? 'right' : 'down'} mr-1.5" id="past-toggle-icon"></i><i class="ph-fill ph-star mr-1.5"></i> Today & Future <span class="ml-2 text-yellow-600 font-bold" id="past-toggle-label">${pastCollapseLabel(collapsed, pastItemCount, pastClearedCount, pastUnclearedCount)}</span></span></td>`;
                        tbody.appendChild(toggleTr);

                        // Apply collapsed state â€” keep uncleared past rows visible
                        if (collapsed) pastRows.forEach(r => { r.style.display = r.classList.contains('past-uncleared') ? '' : 'none'; });
                    }
                    dividerDrawn = true;
                }

                // Cleared items are effectively $0 â€” they no longer impact the running total
                if (txn.status !== 'cleared') {
                    if (txn.type === 'deposit') { runningTotal += txn.amount; remainingDeposits += txn.amount; }
                    else { runningTotal -= txn.amount; remainingWithdrawals += txn.amount; }
                }

                const isCleared = txn.status === 'cleared';
                const isPast = txn.date < todayStr;
                
                let rowBgClass = ''; let warningIcon = ''; let dateColor = 'text-slate-500';

                if (isPast) {
                    if (!isCleared) {
                        rowBgClass = 'bg-rose-50/80 hover:bg-rose-100/80 border-l-4 border-rose-400';
                        warningIcon = `<i class="ph-fill ph-warning-circle text-rose-500 mr-1.5" title="Past Due / Uncleared"></i>`;
                        dateColor = 'text-rose-600 font-extrabold';
                    } else rowBgClass = 'bg-slate-200/80 border-l-4 border-transparent';
                } else if (isCleared) rowBgClass = 'bg-slate-200/70 border-l-4 border-transparent';
                else rowBgClass = 'bg-white hover:bg-slate-50 border-l-4 border-transparent';
                
                const amountColor = txn.type === 'deposit' ? 'text-emerald-600' : 'text-slate-900';
                const amountPrefix = txn.type === 'deposit' ? '+' : '';
                
                let statusSelectColor = '';
                if(txn.status === 'cleared') statusSelectColor = 'bg-slate-100 text-slate-500 border-slate-200';
                else if(txn.status === 'pending') statusSelectColor = 'bg-amber-100 text-amber-800 border-amber-200 shadow-sm';
                else statusSelectColor = 'bg-white text-slate-700 border-slate-300 shadow-sm hover:border-brand-400';

                const catColor = getCatColorClass(txn.type, txn.category);
                const autoIndicator = txn.autoProcess ? `<i class="ph-fill ph-lightning text-brand-500 ml-1.5" title="Auto-processing"></i>` : '';
                const commentIndicator = txn.comment ? `<div class="text-[10px] text-slate-500 mt-0.5 leading-tight italic"><i class="ph-fill ph-chat-text mr-1 text-brand-400"></i>${txn.comment}</div>` : '';
                const commentBtnColor = txn.comment ? 'text-brand-500' : 'text-slate-300 hover:text-brand-500';

                const tr = document.createElement('tr');
                tr.className = `border-b border-slate-100/80 transition-colors group ${rowBgClass} ${isCleared ? 'item-cleared' : ''}`;
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap font-medium ${dateColor}">${formatDate(txn.date)}</td>
                    <td class="py-4 px-6"><div class="flex flex-col"><span class="font-bold text-slate-800 item-name flex items-center">${warningIcon}${txn.name} ${autoIndicator}</span>${commentIndicator}</div></td>
                    <td class="py-4 px-6"><span class="px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wider ${catColor}">${txn.category}</span></td>
                    <td class="py-4 px-6 text-right font-extrabold item-amount ${amountColor}">${amountPrefix}$${txn.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="py-4 px-6 text-center">
                        <select onchange="updateStatus('${txn.id}', this.value)" class="text-xs font-bold uppercase tracking-wider rounded-full px-4 py-1.5 outline-none appearance-none cursor-pointer border text-center transition-colors focus:ring-2 focus:ring-brand-500 w-32 ${statusSelectColor}">
                            <option value="unprocessed" ${txn.status === 'unprocessed' ? 'selected' : ''}>Uncleared</option>
                            <option value="pending" ${txn.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="cleared" ${txn.status === 'cleared' ? 'selected' : ''}>Cleared</option>
                        </select>
                    </td>
                    <td class="py-4 px-6 text-right font-extrabold bg-ledger-highlight/30 border-l border-r border-slate-100/50 ${runningTotal < 0 ? 'text-rose-600' : 'text-slate-900'}">
                        <span>$${runningTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </td>
                    <td class="py-4 px-4 text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <button onclick="openCommentModal('${txn.id}')" class="${commentBtnColor} bg-white hover:bg-brand-50 rounded-full p-1.5 shadow-sm transition-colors" title="Add/Edit Note"><i class="${txn.comment ? 'ph-fill' : 'ph-bold'} ph-chat-text"></i></button>
                            ${isViewingPastMonth ? '' : `<button onclick="editTransaction('${txn.id}')" class="text-slate-300 hover:text-brand-500 bg-white hover:bg-brand-50 rounded-full p-1.5 shadow-sm transition-colors" title="Edit Entry"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deleteTransaction('${txn.id}')" class="text-slate-300 hover:text-rose-500 bg-white hover:bg-rose-50 rounded-full p-1.5 shadow-sm transition-colors" title="Delete Entry"><i class="ph-bold ph-trash"></i></button>`}
                        </div>
                    </td>
                `;
                if (!dividerDrawn) { tr.classList.add('past-ledger-row'); if (!isCleared) tr.classList.add('past-uncleared'); pastRows.push(tr); }
                tbody.appendChild(tr);
            });

            // If all items are past (no future items triggered the divider), add toggle at the end
            if (!dividerDrawn && pastRows.length > 0) {
                const collapsed = state.pastRowsCollapsed !== false;
                const toggleTr = document.createElement('tr');
                toggleTr.id = 'today-divider';
                toggleTr.className = 'bg-yellow-100/50 border-y-2 border-yellow-400 cursor-pointer select-none';
                toggleTr.onclick = () => window.togglePastRows();
                toggleTr.innerHTML = `<td colspan="7" class="py-2.5 px-6 text-center shadow-sm"><span class="text-[11px] font-extrabold uppercase tracking-widest text-yellow-800 flex items-center justify-center"><i class="ph-fill ph-caret-${collapsed ? 'right' : 'down'} mr-1.5" id="past-toggle-icon"></i><i class="ph-fill ph-star mr-1.5"></i> Past Items <span class="ml-2 text-yellow-600 font-bold" id="past-toggle-label">${pastCollapseLabel(collapsed, pastItemCount, pastClearedCount, pastUnclearedCount)}</span></span></td>`;
                tbody.insertBefore(toggleTr, tbody.firstChild);
                if (collapsed) pastRows.forEach(r => { r.style.display = r.classList.contains('past-uncleared') ? '' : 'none'; });
            }

            // Update the 4 metric cards
            document.getElementById('metric-withdrawals').innerText = `$${remainingWithdrawals.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('metric-deposits').innerText = `$${remainingDeposits.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            const delta = remainingDeposits - remainingWithdrawals;
            const deltaEl = document.getElementById('metric-delta');
            deltaEl.innerText = `${delta >= 0 ? '+' : ''}$${delta.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            deltaEl.className = delta < 0
                ? 'text-xl lg:text-2xl font-extrabold tracking-tight z-10 text-rose-600'
                : 'text-xl lg:text-2xl font-extrabold tracking-tight z-10 text-emerald-600';

            const projectedEom = getBankBalanceForCurrentMonth() + delta;
            const projEl = document.getElementById('metric-projected');
            projEl.innerText = `$${projectedEom.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            projEl.className = projectedEom < 0
                ? 'text-xl lg:text-2xl font-extrabold tracking-tight z-10 text-rose-400'
                : 'text-xl lg:text-2xl font-extrabold tracking-tight z-10 text-emerald-400';
        }

        // --- RESTORED FEATURE: Template Grid Mechanics ---
        function setupWeeklyCheckboxes() {
            document.getElementById('tpl-weekly-days').innerHTML = daysOfWeek.map(d => `
                <label class="day-checkbox cursor-pointer relative"><input type="checkbox" value="${d.id}" class="peer sr-only tpl-day-val"><div class="w-9 h-9 sm:w-10 sm:h-10 rounded-full flex items-center justify-center border-2 border-slate-200 bg-white text-slate-500 font-bold transition-all peer-hover:border-brand-300">${d.label}</div></label>
            `).join('');
        }

        function setupMonthlyGrid() {
            let html = '';
            for(let i=1; i<=31; i++) {
                html += `<label class="day-checkbox cursor-pointer relative"><input type="checkbox" value="${i}" class="peer sr-only tpl-month-val"><div class="w-8 h-8 rounded-full flex items-center justify-center border border-slate-200 bg-white text-slate-600 text-xs font-bold transition-all hover:border-brand-300">${i}</div></label>`;
            }
            document.getElementById('tpl-monthly-grid').innerHTML = html;
        }

        window.toggleFrequencyUI = function() {
            const freq = document.getElementById('tpl-frequency').value;
            ['monthly', 'biweekly', 'weekly', 'custom'].forEach(f => document.getElementById(`tpl-ui-${f}`).classList.add('hide'));
            document.getElementById(`tpl-ui-${freq}`).classList.remove('hide');
        }

        window.addCustomDateToDraft = function() {
            const m = document.getElementById('tpl-custom-mm').value.padStart(2, '0');
            const d = document.getElementById('tpl-custom-dd').value.padStart(2, '0');
            if(m > 0 && m <= 12 && d > 0 && d <= 31) {
                const val = `${m}/${d}`;
                if(!tempCustomDates.includes(val)) { tempCustomDates.push(val); renderDraftCustomDates(); }
            }
        }

        function renderDraftCustomDates() {
            document.getElementById('draft-custom-dates').innerHTML = tempCustomDates.map(d => `
                <div class="bg-brand-50 text-brand-700 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center shadow-sm border border-brand-100">${d} <button type="button" onclick="removeCustomDate('${d}')" class="ml-2 text-brand-400 hover:text-rose-500"><i class="ph-bold ph-x"></i></button></div>
            `).join('');
        }

        window.removeCustomDate = function(val) { tempCustomDates = tempCustomDates.filter(d => d !== val); renderDraftCustomDates(); }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            container.innerHTML = '';
            let groups = {};
            state.templates.forEach(tpl => {
                const groupKey = state.templateViewMode === 'category' ? tpl.category : (tpl.frequency.charAt(0).toUpperCase() + tpl.frequency.slice(1));
                if(!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push(tpl);
            });

            Object.keys(groups).sort().forEach(groupName => {
                const section = document.createElement('div');
                section.innerHTML = `<h3 class="font-extrabold text-slate-400 uppercase tracking-wider text-[10px] mb-4 border-b border-slate-200 pb-2">${groupName}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="group-${groupName.replace(/\s+/g, '')}"></div>`;
                container.appendChild(section);
                const grid = section.querySelector('div');
                groups[groupName].forEach(tpl => {
                    const isExpense = tpl.type === 'withdrawal';
                    const catColor = getCatColorClass(tpl.type, tpl.category);
                    let freqText = '';
                    if (tpl.frequency === 'monthly') freqText = `Dates: ${tpl.monthlyDays.join(', ')}`;
                    else if (tpl.frequency === 'biweekly') freqText = `Bi-Weekly from ${tpl.anchorDate || '?'}`;
                    else if (tpl.frequency === 'weekly') freqText = `Weekly: ${tpl.weeklyDays.map(d => daysOfWeek.find(x => x.id === d).label).join(', ')}`;
                    else freqText = `Custom: ${tpl.customDates.join(', ')}`;

                    const div = document.createElement('div');
                    div.className = 'bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between hover:shadow-md transition-shadow relative overflow-hidden group';
                    div.innerHTML = `
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-slate-50 rounded-full opacity-50 pointer-events-none"></div>
                        <div class="relative z-10 flex-1">
                            <div class="flex justify-between items-start mb-4">
                                <span class="px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider ${catColor}">${tpl.category}</span>
                                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editTemplate('${tpl.id}')" class="text-slate-400 hover:text-brand-600 bg-slate-50 hover:bg-brand-50 rounded-full p-2 transition-colors"><i class="ph-bold ph-pencil-simple"></i></button>
                                    <button onclick="deleteTemplate('${tpl.id}')" class="text-slate-400 hover:text-rose-600 bg-slate-50 hover:bg-rose-50 rounded-full p-2 transition-colors"><i class="ph-bold ph-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 leading-tight mb-1">${tpl.name} ${tpl.autoProcess ? 'âš¡' : ''}</h3>
                            <div class="text-3xl font-extrabold ${isExpense ? 'text-slate-900' : 'text-emerald-600'} mb-3 tracking-tight">${isExpense ? '' : '+'}$${tpl.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            <p class="text-xs font-bold text-slate-500 flex items-center bg-slate-50 py-2 px-3 rounded-xl w-fit border border-slate-100">${freqText}</p>
                            <p class="text-[10px] text-slate-400 mt-4 leading-relaxed">${tpl.details || ''}</p>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            });
            if(Object.keys(groups).length === 0) container.innerHTML = '<p class="text-slate-400 italic font-medium py-8">No recurring items created yet.</p>';
        }

        // --- RESTORED FEATURE: Dashboard Logic ---
        function renderDashboard() {
            const txns = getMonthlyTransactions();
            let income = 0; let expense = 0; const expensesByCategory = {};
            let runningTotal = 0; let trendLabels = []; let trendData = [];

            txns.forEach(t => {
                if(t.type === 'deposit') { income += t.amount; runningTotal += t.amount; } 
                else { expense += t.amount; expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount; runningTotal -= t.amount; }
                trendLabels.push(formatDate(t.date)); trendData.push(runningTotal);
            });

            if(cashflowChartObj) cashflowChartObj.destroy();
            if(categoryChartObj) categoryChartObj.destroy();
            if(balanceTrendChartObj) balanceTrendChartObj.destroy();
            if(yearOverviewChartObj) yearOverviewChartObj.destroy();

            Chart.defaults.font.family = '"Plus Jakarta Sans", sans-serif';

            const ctxTrend = document.getElementById('balanceTrendChart').getContext('2d');
            balanceTrendChartObj = new Chart(ctxTrend, {
                type: 'line',
                data: { labels: trendLabels, datasets: [{ label: 'Impact', data: trendData, borderColor: '#6366f1', borderWidth: 3, pointBackgroundColor: '#fff', fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { border: {display: false}, grid: {color: '#f1f5f9'} }, x: { border: {display: false}, grid: {display: false} } } }
            });

            const ctxFlow = document.getElementById('cashflowChart').getContext('2d');
            cashflowChartObj = new Chart(ctxFlow, { type: 'bar', data: { labels: ['Income', 'Withdrawals'], datasets: [{ data: [income, expense], backgroundColor: ['#10b981', '#f43f5e'], borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            categoryChartObj = new Chart(ctxCat, { type: 'doughnut', data: { labels: Object.keys(expensesByCategory), datasets: [{ data: Object.values(expensesByCategory), backgroundColor: ['#4f46e5', '#ec4899', '#f59e0b', '#06b6d4', '#10b981', '#64748b'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right' } } } });

            // --- Year Overview Chart (Janâ€“Dec) ---
            const viewYear = state.currentDate.getFullYear();
            const monthLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const currentMonthIdx = REAL_CURRENT_DATE.getMonth();
            const currentYear = REAL_CURRENT_DATE.getFullYear();
            const eomData = []; const depData = []; const wdData = [];
            const depColors = []; const wdColors = []; const eomPointColors = []; const eomPointRadius = [];

            for (let m = 0; m < 12; m++) {
                const mk = getMonthKey(viewYear, m);
                const bankBal = resolveAutoCarryBalance(mk);
                const monthTxns = state.transactions.filter(t => t.date.startsWith(mk));
                let deposits = 0, withdrawals = 0, unclearedDep = 0, unclearedWd = 0;
                monthTxns.forEach(t => {
                    if (t.type === 'deposit') { deposits += t.amount; if (t.status !== 'cleared') unclearedDep += t.amount; }
                    else { withdrawals += t.amount; if (t.status !== 'cleared') unclearedWd += t.amount; }
                });
                const projectedEom = bankBal + unclearedDep - unclearedWd;
                eomData.push(monthTxns.length > 0 || state.monthlyBalances[mk] ? projectedEom : null);
                depData.push(deposits || null);
                wdData.push(withdrawals || null);

                const isCurrent = (viewYear === currentYear && m === currentMonthIdx);
                depColors.push(isCurrent ? '#059669' : '#10b981');
                wdColors.push(isCurrent ? '#e11d48' : '#f43f5e');
                eomPointColors.push(isCurrent ? '#4338ca' : '#6366f1');
                eomPointRadius.push(isCurrent ? 7 : 4);
            }

            document.getElementById('yearOverviewLabel').textContent = viewYear;

            const ctxYear = document.getElementById('yearOverviewChart').getContext('2d');
            yearOverviewChartObj = new Chart(ctxYear, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            type: 'line', label: 'Projected EoM', data: eomData, borderColor: '#6366f1', borderWidth: 3,
                            pointBackgroundColor: eomPointColors, pointRadius: eomPointRadius, pointBorderColor: '#fff', pointBorderWidth: 2,
                            fill: false, tension: 0.3, yAxisID: 'y', order: 0, spanGaps: true
                        },
                        {
                            label: 'Deposits', data: depData, backgroundColor: depColors,
                            borderRadius: 6, yAxisID: 'y', order: 1, barPercentage: 0.7, categoryPercentage: 0.8
                        },
                        {
                            label: 'Withdrawals', data: wdData, backgroundColor: wdColors,
                            borderRadius: 6, yAxisID: 'y', order: 2, barPercentage: 0.7, categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true, padding: 20, font: { size: 11, weight: '600' } } },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: $${(ctx.parsed.y || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                                title: items => { const m = items[0].dataIndex; return (viewYear === currentYear && m === currentMonthIdx) ? `${items[0].label} (Current)` : items[0].label; }
                            }
                        }
                    },
                    scales: {
                        y: {
                            border: { display: false }, grid: { color: '#f1f5f9' },
                            ticks: { callback: v => '$' + v.toLocaleString() }
                        },
                        x: {
                            border: { display: false }, grid: { display: false },
                            ticks: {
                                font: function(ctx) {
                                    return (viewYear === currentYear && ctx.index === currentMonthIdx)
                                        ? { weight: '800', size: 13 } : { weight: '500', size: 11 };
                                },
                                color: function(ctx) {
                                    return (viewYear === currentYear && ctx.index === currentMonthIdx) ? '#4f46e5' : '#64748b';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'currentMonthHighlight',
                    beforeDraw(chart) {
                        if (viewYear !== currentYear) return;
                        const { ctx: c, chartArea, scales: { x } } = chart;
                        const barWidth = x.getPixelForValue(1) - x.getPixelForValue(0);
                        const xPos = x.getPixelForValue(currentMonthIdx) - barWidth / 2;
                        c.save();
                        c.fillStyle = 'rgba(99, 102, 241, 0.06)';
                        c.roundRect(xPos, chartArea.top, barWidth, chartArea.bottom - chartArea.top, 8);
                        c.fill();
                        c.restore();
                    }
                }]
            });
        }

        // --- MISSING CRITICAL FUNCTIONS: Status, Delete, Edit, Comments ---
        window.updateStatus = function(txnId, newStatus) {
            setDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId), { status: newStatus }, { merge: true });
        }

        window.deleteTransaction = async function(txnId) {
            const txn = state.transactions.find(t => t.id === txnId);
            if (txn && txn.date.substring(0, 7) < CURRENT_MONTH_KEY) { alert('Past month entries cannot be deleted.'); return; }
            if (!confirm('Delete this ledger entry?')) return;
            await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId));
        }

        window.deleteTemplate = function(tplId) {
            if (!confirm('Delete this recurring item? This will also remove all uncleared entries it generated.')) return;
            // Delete the template (fire-and-forget)
            deleteDoc(doc(db, 'users', currentUser.uid, 'templates', tplId));
            // Clean up unprocessed transactions from this template in current/future months only (fire-and-forget)
            state.transactions.filter(t => t.templateId === tplId && t.status === 'unprocessed' && t.date.substring(0, 7) >= CURRENT_MONTH_KEY).forEach(t => {
                deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', t.id));
            });
        }

        window.refreshLedgerFromTemplates = function() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const viewKey = getMonthKey(year, month);
            if (viewKey < CURRENT_MONTH_KEY) { alert('Past months are locked and cannot be refreshed.'); return; }

            state.templates.forEach(tpl => {
                const dates = getTemplateDatesForMonth(tpl, year, month);

                // Update existing unprocessed entries with current template values
                state.transactions
                    .filter(t => t.templateId === tpl.id && t.status === 'unprocessed')
                    .forEach(t => {
                        if (dates.includes(t.date)) {
                            setDoc(doc(db, 'users', currentUser.uid, 'transactions', t.id), {
                                name: tpl.name, amount: tpl.amount, type: tpl.type,
                                category: tpl.category, autoProcess: tpl.autoProcess || false
                            }, { merge: true });
                        }
                    });

                // Create any missing entries for this month
                dates.forEach(dateStr => {
                    if (!state.transactions.some(t => t.templateId === tpl.id && t.date === dateStr)) {
                        const txnId = `tplgen_${tpl.id}_${dateStr}_${Math.random().toString(36).substr(2, 5)}`;
                        setDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId), {
                            id: txnId, templateId: tpl.id, date: dateStr, name: tpl.name,
                            amount: tpl.amount, type: tpl.type, category: tpl.category,
                            status: 'unprocessed', autoProcess: tpl.autoProcess || false, comment: ''
                        });
                    }
                });
            });
        }

        window.editTemplate = function(tplId) {
            const tpl = state.templates.find(t => t.id === tplId);
            if (!tpl) return;
            document.getElementById('tpl-id').value = tpl.id;
            document.getElementById('tpl-name').value = tpl.name;
            document.getElementById('tpl-amount').value = tpl.amount;
            document.getElementById('tpl-type').value = tpl.type;
            updateCategoryOptions('tpl-category', tpl.type);
            document.getElementById('tpl-category').value = tpl.category;
            document.getElementById('tpl-details').value = tpl.details || '';
            document.getElementById('tpl-autoprocess').checked = tpl.autoProcess || false;
            document.getElementById('tpl-frequency').value = tpl.frequency;
            document.getElementById('tpl-modal-title').innerText = 'Edit Template';
            toggleFrequencyUI();

            // Reset all checkboxes and biweekly anchor first
            document.querySelectorAll('.tpl-month-val, .tpl-day-val').forEach(cb => cb.checked = false);
            document.getElementById('tpl-anchor-date').value = '';
            tempCustomDates = [];

            if (tpl.frequency === 'monthly' && tpl.monthlyDays) {
                tpl.monthlyDays.forEach(day => {
                    const cb = document.querySelector(`.tpl-month-val[value="${day}"]`);
                    if (cb) cb.checked = true;
                });
            } else if (tpl.frequency === 'biweekly' && tpl.anchorDate) {
                document.getElementById('tpl-anchor-date').value = tpl.anchorDate;
            } else if (tpl.frequency === 'weekly' && tpl.weeklyDays) {
                tpl.weeklyDays.forEach(day => {
                    const cb = document.querySelector(`.tpl-day-val[value="${day}"]`);
                    if (cb) cb.checked = true;
                });
            } else if (tpl.frequency === 'custom' && tpl.customDates) {
                tempCustomDates = [...tpl.customDates];
                renderDraftCustomDates();
            }

            openModal('template');
        }

        window.openCommentModal = function(txnId) {
            const txn = state.transactions.find(t => t.id === txnId);
            if (!txn) return;
            document.getElementById('edit-comment-id').value = txnId;
            document.getElementById('edit-comment-text').value = txn.comment || '';
            openModal('comment');
        }

        window.saveLedgerComment = function() {
            const txnId = document.getElementById('edit-comment-id').value;
            const text = document.getElementById('edit-comment-text').value.trim();
            setDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId), { comment: text }, { merge: true });
            closeModal('comment');
        }

        window.setTemplateView = function(mode) {
            state.templateViewMode = mode;
            const btnCat = document.getElementById('btn-view-cat');
            const btnRec = document.getElementById('btn-view-rec');
            if (mode === 'category') {
                btnCat.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-brand-600 shadow-sm transition-all';
                btnRec.className = 'px-3 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all';
            } else {
                btnRec.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-brand-600 shadow-sm transition-all';
                btnCat.className = 'px-3 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all';
            }
            renderTemplates();
        }

        // --- ACTIONS & NAVIGATION ---
        window.switchTab = function(tabId) {
            ['ledger', 'templates', 'dashboard'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hide');
                const navEl = document.getElementById(`nav-${t}`);
                if(navEl) { navEl.classList.remove('bg-brand-50', 'text-brand-600'); navEl.classList.add('text-slate-500'); }
            });
            document.getElementById(`view-${tabId}`).classList.remove('hide');
            const activeNav = document.getElementById(`nav-${tabId}`);
            if(activeNav) { activeNav.classList.add('bg-brand-50', 'text-brand-600'); activeNav.classList.remove('text-slate-500'); }
            if(tabId === 'dashboard') renderDashboard();
            if(tabId === 'templates') renderTemplates();
        }

        window.updateCategoryOptions = function(selectId, type) {
            const select = document.getElementById(selectId);
            const currentVal = select.value;
            select.innerHTML = '';
            categoryConfig[type].forEach(cat => { const opt = document.createElement('option'); opt.value = cat.name; opt.innerText = cat.name; select.appendChild(opt); });
            if(categoryConfig[type].find(c => c.name === currentVal)) select.value = currentVal;
        }

        window.openModal = function(type) {
            const modal = document.getElementById(`modal-${type}`);
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
        }

        window.closeModal = function(type) {
            const modal = document.getElementById(`modal-${type}`);
            modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
        }

        // Close topmost visible modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modals = ['washu', 'comment', 'transaction', 'template', 'settings'];
                for (const type of modals) {
                    const modal = document.getElementById(`modal-${type}`);
                    if (modal && !modal.classList.contains('hidden')) { closeModal(type); break; }
                }
            }
        });

        window.openTransactionModal = function() {
            document.getElementById('form-transaction').reset();
            document.getElementById('txn-id').value = '';
            const year = state.currentDate.getFullYear(); const month = (state.currentDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('txn-date').value = `${year}-${month}-01`;
            updateCategoryOptions('txn-category', 'withdrawal');
            openModal('transaction');
        }

        window.editTransaction = function(txnId) {
            const txn = state.transactions.find(t => t.id === txnId);
            if (!txn) return;
            if (txn.date.substring(0, 7) < CURRENT_MONTH_KEY) { alert('Past month entries cannot be edited.'); return; }
            document.getElementById('txn-id').value = txn.id;
            document.getElementById('txn-date').value = txn.date;
            document.getElementById('txn-name').value = txn.name;
            document.getElementById('txn-amount').value = txn.amount;
            document.getElementById('txn-type').value = txn.type;
            updateCategoryOptions('txn-category', txn.type);
            document.getElementById('txn-category').value = txn.category;
            document.getElementById('txn-comment').value = txn.comment || '';
            openModal('transaction');
        }

        window.openTemplateModal = function() {
            document.getElementById('form-template').reset();
            document.getElementById('tpl-id').value = '';
            document.getElementById('tpl-modal-title').innerText = 'New Template';
            tempCustomDates = []; renderDraftCustomDates();
            updateCategoryOptions('tpl-category', 'withdrawal');
            document.querySelectorAll('.tpl-month-val, .tpl-day-val').forEach(cb => cb.checked = false);
            document.getElementById('tpl-anchor-date').value = '';
            toggleFrequencyUI();
            openModal('template');
        }

        window.handleTransactionSubmit = function(e) {
            e.preventDefault();
            const existingId = document.getElementById('txn-id').value;
            const id = existingId || 't_' + Date.now();
            const txnData = { id, date: document.getElementById('txn-date').value, name: document.getElementById('txn-name').value, amount: parseFloat(document.getElementById('txn-amount').value), type: document.getElementById('txn-type').value, category: document.getElementById('txn-category').value, comment: document.getElementById('txn-comment').value };
            if (existingId) {
                // Editing: merge to preserve templateId, autoProcess, status
                setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), txnData, { merge: true });
            } else {
                txnData.status = 'unprocessed';
                setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), txnData);
            }
            closeModal('transaction');
        }

        window.handleTemplateSubmit = function(e) {
            e.preventDefault();
            const isEdit = !!document.getElementById('tpl-id').value;
            const id = document.getElementById('tpl-id').value || 'tpl_' + Date.now();
            const freq = document.getElementById('tpl-frequency').value;
            let tpl = { id, name: document.getElementById('tpl-name').value, amount: parseFloat(document.getElementById('tpl-amount').value), type: document.getElementById('tpl-type').value, category: document.getElementById('tpl-category').value, frequency: freq, autoProcess: document.getElementById('tpl-autoprocess').checked, details: document.getElementById('tpl-details').value };
            if(freq === 'monthly') tpl.monthlyDays = Array.from(document.querySelectorAll('.tpl-month-val:checked')).map(cb => parseInt(cb.value));
            else if(freq === 'biweekly') tpl.anchorDate = document.getElementById('tpl-anchor-date').value;
            else if(freq === 'weekly') tpl.weeklyDays = Array.from(document.querySelectorAll('.tpl-day-val:checked')).map(cb => parseInt(cb.value));
            else tpl.customDates = [...tempCustomDates];

            // Save template (fire-and-forget)
            setDoc(doc(db, 'users', currentUser.uid, 'templates', id), tpl);

            if (isEdit) {
                // Sync unprocessed entries in current/future months only (fire-and-forget)
                const unprocessed = state.transactions.filter(t => t.templateId === id && t.status === 'unprocessed' && t.date.substring(0, 7) >= CURRENT_MONTH_KEY);

                // Build set of valid dates for current/future initialized months
                const validDates = new Set();
                state.initializedMonths.filter(mk => mk >= CURRENT_MONTH_KEY).forEach(mk => {
                    const [y, m] = mk.split('-').map(Number);
                    getTemplateDatesForMonth(tpl, y, m - 1).forEach(d => validDates.add(d));
                });

                // Update entries that still match a valid date, delete ones that don't
                unprocessed.forEach(t => {
                    if (validDates.has(t.date)) {
                        // Update with new template values, preserve comment
                        setDoc(doc(db, 'users', currentUser.uid, 'transactions', t.id), {
                            name: tpl.name, amount: tpl.amount, type: tpl.type,
                            category: tpl.category, autoProcess: tpl.autoProcess || false
                        }, { merge: true });
                    } else {
                        // Date no longer in schedule â€” remove
                        deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', t.id));
                    }
                });

                // Create entries for new dates not yet covered (current/future months only)
                const existingDates = new Set(state.transactions.filter(t => t.templateId === id && t.date.substring(0, 7) >= CURRENT_MONTH_KEY).map(t => t.date));
                validDates.forEach(dateStr => {
                    if (!existingDates.has(dateStr)) {
                        const txnId = `tplgen_${id}_${dateStr}_${Math.random().toString(36).substr(2, 5)}`;
                        setDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId), {
                            id: txnId, templateId: id, date: dateStr, name: tpl.name,
                            amount: tpl.amount, type: tpl.type, category: tpl.category,
                            status: 'unprocessed', autoProcess: tpl.autoProcess || false, comment: ''
                        });
                    }
                });
            } else {
                // New template â€” create ledger entries for all initialized current/future months
                state.initializedMonths.filter(mk => mk >= CURRENT_MONTH_KEY).forEach(mk => {
                    const [y, m] = mk.split('-').map(Number);
                    getTemplateDatesForMonth(tpl, y, m - 1).forEach(dateStr => {
                        if (!state.transactions.some(t => t.templateId === id && t.date === dateStr)) {
                            const txnId = `tplgen_${id}_${dateStr}_${Math.random().toString(36).substr(2, 5)}`;
                            setDoc(doc(db, 'users', currentUser.uid, 'transactions', txnId), {
                                id: txnId, templateId: id, date: dateStr, name: tpl.name,
                                amount: tpl.amount, type: tpl.type, category: tpl.category,
                                status: 'unprocessed', autoProcess: tpl.autoProcess || false, comment: ''
                            });
                        }
                    });
                });
            }

            closeModal('template');
        }

        function getMonthlyTransactions() {
            const mKey = getMonthKey(state.currentDate.getFullYear(), state.currentDate.getMonth());
            return state.transactions.filter(t => t.date.startsWith(mKey)).sort((a,b) => new Date(a.date) - new Date(b.date));
        }

        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return new Date(y, m - 1, d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // --- EXPORT / IMPORT ---
        window.exportData = function() {
            const backup = {
                version: 1,
                exportedAt: new Date().toISOString(),
                settings: {
                    monthlyBalances: state.monthlyBalances,
                    initializedMonths: state.initializedMonths
                },
                templates: state.templates,
                transactions: state.transactions
            };
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `buft-backup-${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.importData = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const statusEl = document.getElementById('import-status');

            try {
                const text = await file.text();
                const backup = JSON.parse(text);

                // Validate structure
                if (!backup.settings || !Array.isArray(backup.templates) || !Array.isArray(backup.transactions)) {
                    statusEl.textContent = 'Invalid backup file format.';
                    statusEl.className = 'mt-3 text-center text-sm font-bold text-rose-600';
                    statusEl.classList.remove('hidden');
                    event.target.value = '';
                    return;
                }

                if (!confirm(`This will WIPE all existing data and restore from backup (${backup.exportedAt || 'unknown date'}).\n\n${backup.templates.length} templates, ${backup.transactions.length} transactions.\n\nContinue?`)) {
                    event.target.value = '';
                    return;
                }

                statusEl.textContent = 'Wiping existing data...';
                statusEl.className = 'mt-3 text-center text-sm font-bold text-amber-600';
                statusEl.classList.remove('hidden');

                const uid = currentUser.uid;

                // Wipe existing transactions
                const txnSnap = await getDocs(collection(db, 'users', uid, 'transactions'));
                let wipeBatch = writeBatch(db);
                let batchCount = 0;
                for (const d of txnSnap.docs) {
                    wipeBatch.delete(d.ref);
                    batchCount++;
                    if (batchCount >= 400) { await wipeBatch.commit(); wipeBatch = writeBatch(db); batchCount = 0; }
                }

                // Wipe existing templates
                const tplSnap = await getDocs(collection(db, 'users', uid, 'templates'));
                for (const d of tplSnap.docs) {
                    wipeBatch.delete(d.ref);
                    batchCount++;
                    if (batchCount >= 400) { await wipeBatch.commit(); wipeBatch = writeBatch(db); batchCount = 0; }
                }
                if (batchCount > 0) await wipeBatch.commit();

                statusEl.textContent = 'Restoring backup...';

                // Write settings
                // Support importing old (bankBalance) or new (monthlyBalances) format
                const importedBalances = backup.settings.monthlyBalances || (typeof backup.settings.bankBalance === 'number' ? { [getMonthKey(REAL_CURRENT_DATE.getFullYear(), REAL_CURRENT_DATE.getMonth())]: { amount: backup.settings.bankBalance, autoCarry: false } } : {});
                await setDoc(doc(db, 'users', uid, 'settings', 'main'), {
                    monthlyBalances: importedBalances,
                    initializedMonths: backup.settings.initializedMonths || [],
                    hasAcceptedTerms: true
                });

                // Write templates in batches
                let restoreBatch = writeBatch(db);
                batchCount = 0;
                for (const tpl of backup.templates) {
                    restoreBatch.set(doc(db, 'users', uid, 'templates', tpl.id), tpl);
                    batchCount++;
                    if (batchCount >= 400) { await restoreBatch.commit(); restoreBatch = writeBatch(db); batchCount = 0; }
                }

                // Write transactions in batches
                for (const txn of backup.transactions) {
                    restoreBatch.set(doc(db, 'users', uid, 'transactions', txn.id), txn);
                    batchCount++;
                    if (batchCount >= 400) { await restoreBatch.commit(); restoreBatch = writeBatch(db); batchCount = 0; }
                }
                if (batchCount > 0) await restoreBatch.commit();

                statusEl.textContent = 'Restore complete! Reloading...';
                statusEl.className = 'mt-3 text-center text-sm font-bold text-emerald-600';
                setTimeout(() => location.reload(), 1500);

            } catch (err) {
                console.error('Import error:', err);
                statusEl.textContent = 'Import failed: ' + err.message;
                statusEl.className = 'mt-3 text-center text-sm font-bold text-rose-600';
                statusEl.classList.remove('hidden');
            }
            event.target.value = '';
        }

        // --- ASK WASHU: AI Chat Engine (Multi-Provider) ---
        let washuConversation = []; // Multi-turn history: [{role: 'user'|'assistant', content: '...'}]
        let washuIsStreaming = false;
        let washuAbortController = null;
        let washuLastApiTime = null;
        let washuTimerInterval = null;
        let washuLastApiLabel = '';

        // Provider config
        const WASHU_PROVIDER_DEFAULTS = {
            'gemini': { endpoint: 'https://generativelanguage.googleapis.com/v1beta', model: 'gemini-2.0-flash', keyRequired: true, keyHint: 'Get a key at <a href="https://aistudio.google.com/apikey" target="_blank" class="font-bold text-brand-600 hover:underline">aistudio.google.com</a>' },
            'openai-compatible': { endpoint: 'http://localhost:11434', model: 'llama3', keyRequired: false, keyHint: 'Optional â€” only needed for cloud providers like OpenRouter.' }
        };
        let washuConfig = { provider: '', endpoint: '', model: '', apiKey: '' };

        function startWashuTimer(label) {
            washuLastApiTime = Date.now();
            washuLastApiLabel = label;
            const timerEl = document.getElementById('washu-api-timer');
            const textEl = document.getElementById('washu-timer-text');
            timerEl.classList.remove('hidden');
            updateWashuTimerDisplay();
            if (washuTimerInterval) clearInterval(washuTimerInterval);
            washuTimerInterval = setInterval(updateWashuTimerDisplay, 1000);
        }

        function updateWashuTimerDisplay() {
            if (!washuLastApiTime) return;
            const textEl = document.getElementById('washu-timer-text');
            const elapsed = Math.floor((Date.now() - washuLastApiTime) / 1000);
            let timeStr;
            if (elapsed < 60) timeStr = `${elapsed}s`;
            else if (elapsed < 3600) timeStr = `${Math.floor(elapsed / 60)}m ${elapsed % 60}s`;
            else timeStr = `${Math.floor(elapsed / 3600)}h ${Math.floor((elapsed % 3600) / 60)}m`;
            textEl.textContent = `${washuLastApiLabel} ${timeStr} ago`;
        }

        function getWashuSystemPrompt() {
            return `You are **Washu**, the Bienvenu Family AI Persona, created by Paul Bienvenu. Your personality is modeled after Washu Hakubi from the Tenchi Muyo series â€” you're a witty, self-proclaimed greatest genius in the universe. You're confident, playful, and occasionally smug, but always helpful and insightful. You sprinkle in light humor and clever observations. You refer to yourself as Washu.

You are embedded inside BUFT (BakaNeko's Ultimate Finance Tool), a personal finance ledger app. Your job is to analyze the user's financial data and answer their questions with sharp, actionable insights.

**Formatting rules:**
- Use **bold** for emphasis, numbers, and key terms
- Use bullet points for lists
- Keep responses concise but thorough
- Use dollar amounts with two decimal places
- When comparing months, clearly label each month

**Important financial concepts in BUFT:**
- "Cleared" items have already hit the bank account and do NOT affect the running total or projections (they are already reflected in the bank balance)
- "Unprocessed" and "Pending" items are still outstanding â€” they DO affect the projected end-of-month balance
- "Bank Balance" is the starting balance for the month (what's actually in the bank)
- "Projected EoM" = Bank Balance + all non-cleared deposits - all non-cleared withdrawals
- Templates are recurring items that auto-generate ledger entries each month
- Auto-process items automatically clear when their date passes

Here is the user's complete BUFT financial data:

${buildWashuContext()}`;
        }

        function buildWashuContext() {
            const lines = [];
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            // Current viewing context
            lines.push(`**Today's Date:** ${REAL_CURRENT_DATE.toISOString().split('T')[0]}`);
            lines.push(`**Currently Viewing:** ${monthNames[state.currentDate.getMonth()]} ${state.currentDate.getFullYear()}`);
            lines.push('');

            // All months with data
            const allMonthKeys = new Set();
            state.transactions.forEach(t => {
                const mk = t.date.substring(0, 7);
                allMonthKeys.add(mk);
            });
            Object.keys(state.monthlyBalances).forEach(k => allMonthKeys.add(k));
            const sortedMonths = [...allMonthKeys].sort();

            sortedMonths.forEach(mk => {
                const [year, month] = mk.split('-').map(Number);
                const monthName = monthNames[month - 1];
                const entry = getMonthBalanceEntry(mk);
                const bankBal = resolveAutoCarryBalance(mk);
                const monthTxns = state.transactions.filter(t => t.date.startsWith(mk)).sort((a, b) => a.date.localeCompare(b.date));

                if (monthTxns.length === 0 && !state.monthlyBalances[mk]) return;

                lines.push(`--- ${monthName} ${year} ---`);
                lines.push(`Bank Balance: $${bankBal.toFixed(2)}${entry.autoCarry ? ' (auto-carried from previous month)' : ''}`);

                let unclearedW = 0, unclearedD = 0, clearedW = 0, clearedD = 0;
                monthTxns.forEach(t => {
                    if (t.status === 'cleared') {
                        if (t.type === 'withdrawal') clearedW += t.amount;
                        else clearedD += t.amount;
                    } else {
                        if (t.type === 'withdrawal') unclearedW += t.amount;
                        else unclearedD += t.amount;
                    }
                });

                lines.push(`Outstanding Withdrawals: $${unclearedW.toFixed(2)} | Outstanding Deposits: $${unclearedD.toFixed(2)}`);
                lines.push(`Already Cleared: $${clearedW.toFixed(2)} withdrawn, $${clearedD.toFixed(2)} deposited`);
                lines.push(`Projected EoM: $${(bankBal + unclearedD - unclearedW).toFixed(2)}`);
                lines.push('');
                lines.push('Transactions:');

                monthTxns.forEach(t => {
                    const sign = t.type === 'deposit' ? '+' : '-';
                    const status = t.status === 'cleared' ? '[CLEARED]' : t.status === 'pending' ? '[PENDING]' : '[UNCLEARED]';
                    const auto = t.autoProcess ? ' (auto)' : '';
                    const comment = t.comment ? ` â€” "${t.comment}"` : '';
                    lines.push(`  ${t.date} | ${sign}$${t.amount.toFixed(2)} | ${t.name} | ${t.category} | ${status}${auto}${comment}`);
                });
                lines.push('');
            });

            // Templates
            if (state.templates.length > 0) {
                lines.push('--- RECURRING TEMPLATES ---');
                state.templates.forEach(tpl => {
                    const sign = tpl.type === 'deposit' ? '+' : '-';
                    let freq = tpl.frequency;
                    if (tpl.frequency === 'monthly') freq = `Monthly on days: ${tpl.monthlyDays?.join(', ')}`;
                    else if (tpl.frequency === 'biweekly') freq = `Bi-weekly from ${tpl.anchorDate}`;
                    else if (tpl.frequency === 'weekly') freq = `Weekly on days: ${tpl.weeklyDays?.map(d => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]).join(', ')}`;
                    else if (tpl.frequency === 'custom') freq = `Custom dates: ${tpl.customDates?.join(', ')}`;
                    const auto = tpl.autoProcess ? ' [AUTO-PROCESS]' : '';
                    lines.push(`  ${sign}$${tpl.amount.toFixed(2)} | ${tpl.name} | ${tpl.category} | ${freq}${auto}`);
                });
            }

            return lines.join('\n');
        }

        // --- Washu Provider UI helpers ---
        window.onWashuProviderChange = function() {
            const provider = document.getElementById('settings-washu-provider').value;
            const defaults = WASHU_PROVIDER_DEFAULTS[provider];
            document.getElementById('settings-washu-endpoint').value = defaults.endpoint;
            document.getElementById('settings-washu-endpoint').placeholder = defaults.endpoint;
            document.getElementById('settings-washu-model').value = defaults.model;
            document.getElementById('settings-washu-model').placeholder = defaults.model;
            document.getElementById('washu-key-required').textContent = defaults.keyRequired ? '(required)' : '(optional)';
            document.getElementById('washu-key-required').className = defaults.keyRequired ? 'ml-1.5 text-rose-400' : 'ml-1.5 text-slate-400';
            document.getElementById('washu-key-hint').innerHTML = defaults.keyHint;
            document.getElementById('settings-washu-key').value = '';
            document.getElementById('settings-washu-key').placeholder = defaults.keyRequired ? 'AIza...' : 'sk-... (optional)';
            // Mixed-content warning
            checkWashuMixedContent();
        }

        function checkWashuMixedContent() {
            const endpoint = document.getElementById('settings-washu-endpoint').value.trim();
            const warn = document.getElementById('washu-mixed-content-warning');
            if (window.location.protocol === 'https:' && endpoint.startsWith('http://')) {
                warn.classList.remove('hidden');
            } else {
                warn.classList.add('hidden');
            }
        }

        // --- Washu Provider save/load ---
        window.saveWashuProvider = function() {
            const provider = document.getElementById('settings-washu-provider').value;
            const endpoint = document.getElementById('settings-washu-endpoint').value.trim() || WASHU_PROVIDER_DEFAULTS[provider].endpoint;
            const model = document.getElementById('settings-washu-model').value.trim() || WASHU_PROVIDER_DEFAULTS[provider].model;
            const apiKey = document.getElementById('settings-washu-key').value.trim();
            const defaults = WASHU_PROVIDER_DEFAULTS[provider];
            const statusEl = document.getElementById('washu-provider-status');

            // Validate: key required for Gemini
            if (defaults.keyRequired && !apiKey && !washuConfig.apiKey) {
                statusEl.textContent = 'API key is required for this provider.';
                statusEl.className = 'text-[11px] font-bold mt-2 text-rose-600';
                return;
            }

            washuConfig.provider = provider;
            washuConfig.endpoint = endpoint;
            washuConfig.model = model;
            if (apiKey) washuConfig.apiKey = apiKey; // don't overwrite existing key if field is masked

            setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), {
                washuProvider: provider,
                washuEndpoint: endpoint,
                washuModel: model,
                washuApiKey: washuConfig.apiKey
            }, { merge: true });

            statusEl.textContent = 'Saved! Ask Washu is ready.';
            statusEl.className = 'text-[11px] font-bold mt-2 text-emerald-600';
            document.getElementById('btn-ask-washu').classList.remove('hide');
        }

        function loadWashuProviderFromSettings(data) {
            if (!data) return;
            // Backward compat: migrate old geminiApiKey-only config
            if (data.geminiApiKey && !data.washuProvider) {
                washuConfig.provider = 'gemini';
                washuConfig.endpoint = WASHU_PROVIDER_DEFAULTS['gemini'].endpoint;
                washuConfig.model = WASHU_PROVIDER_DEFAULTS['gemini'].model;
                washuConfig.apiKey = data.geminiApiKey;
            } else if (data.washuProvider) {
                washuConfig.provider = data.washuProvider;
                washuConfig.endpoint = data.washuEndpoint || WASHU_PROVIDER_DEFAULTS[data.washuProvider]?.endpoint || '';
                washuConfig.model = data.washuModel || WASHU_PROVIDER_DEFAULTS[data.washuProvider]?.model || '';
                washuConfig.apiKey = data.washuApiKey || '';
            } else {
                return; // No AI config at all
            }

            // Populate UI fields
            document.getElementById('settings-washu-provider').value = washuConfig.provider;
            document.getElementById('settings-washu-endpoint').value = washuConfig.endpoint;
            document.getElementById('settings-washu-model').value = washuConfig.model;
            if (washuConfig.apiKey) {
                document.getElementById('settings-washu-key').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }
            const defaults = WASHU_PROVIDER_DEFAULTS[washuConfig.provider];
            if (defaults) {
                document.getElementById('washu-key-required').textContent = defaults.keyRequired ? '(required)' : '(optional)';
                document.getElementById('washu-key-required').className = defaults.keyRequired ? 'ml-1.5 text-rose-400' : 'ml-1.5 text-slate-400';
                document.getElementById('washu-key-hint').innerHTML = defaults.keyHint;
                document.getElementById('settings-washu-key').placeholder = defaults.keyRequired ? 'AIza...' : 'sk-... (optional)';
            }

            document.getElementById('btn-ask-washu').classList.remove('hide');
            const statusEl = document.getElementById('washu-provider-status');
            statusEl.textContent = `${washuConfig.provider === 'gemini' ? 'Gemini' : 'OpenAI-compatible'} provider loaded.`;
            statusEl.className = 'text-[11px] font-bold mt-2 text-emerald-600';
        }

        // --- Test Connection ---
        window.testWashuConnection = async function() {
            const provider = document.getElementById('settings-washu-provider').value;
            const endpoint = document.getElementById('settings-washu-endpoint').value.trim() || WASHU_PROVIDER_DEFAULTS[provider].endpoint;
            const model = document.getElementById('settings-washu-model').value.trim() || WASHU_PROVIDER_DEFAULTS[provider].model;
            let apiKey = document.getElementById('settings-washu-key').value.trim();
            if (apiKey === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') apiKey = washuConfig.apiKey; // use saved key if field is masked
            const statusEl = document.getElementById('washu-provider-status');
            statusEl.textContent = 'Testing connection...';
            statusEl.className = 'text-[11px] font-bold mt-2 text-slate-500';

            try {
                const req = buildProviderRequest(provider, endpoint, model, apiKey, 'Reply with just the word OK.', [{ role: 'user', content: 'Say OK' }]);
                const resp = await fetch(req.url, { method: 'POST', headers: req.headers, body: JSON.stringify(req.body), signal: AbortSignal.timeout(15000) });
                if (!resp.ok) {
                    const errText = await resp.text();
                    let msg = '';
                    try { msg = JSON.parse(errText)?.error?.message || ''; } catch(_) {}
                    throw new Error(`HTTP ${resp.status}: ${msg || errText.substring(0, 200)}`);
                }
                const result = await resp.json();
                const text = parseProviderResponse(provider, result);
                if (!text) throw new Error('Empty response â€” check model name.');
                statusEl.textContent = `Connected! Model responded: "${text.substring(0, 60)}"`;
                statusEl.className = 'text-[11px] font-bold mt-2 text-emerald-600';
            } catch (err) {
                statusEl.textContent = `Connection failed: ${err.message}`;
                statusEl.className = 'text-[11px] font-bold mt-2 text-rose-600';
            }
        }

        // --- Provider Translation Layer ---
        function buildProviderRequest(provider, endpoint, model, apiKey, systemPrompt, conversation) {
            if (provider === 'gemini') {
                // Gemini format
                const geminiContents = conversation.map(m => ({
                    role: m.role === 'assistant' ? 'model' : m.role,
                    parts: [{ text: m.content }]
                }));
                return {
                    url: `${endpoint}/models/${model}:generateContent?key=${apiKey}`,
                    headers: { 'Content-Type': 'application/json' },
                    body: {
                        system_instruction: { parts: [{ text: systemPrompt }] },
                        contents: geminiContents,
                        generationConfig: { temperature: 0.8, topP: 0.95, maxOutputTokens: 2048 }
                    }
                };
            } else {
                // OpenAI-compatible format (Ollama, LM Studio, OpenRouter, etc.)
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...conversation.map(m => ({ role: m.role, content: m.content }))
                ];
                const headers = { 'Content-Type': 'application/json' };
                if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;
                // Normalize endpoint: strip trailing slash, add /v1/chat/completions if not present
                let url = endpoint.replace(/\/+$/, '');
                if (!url.includes('/v1/chat/completions')) url += '/v1/chat/completions';
                return {
                    url,
                    headers,
                    body: { model, messages, temperature: 0.8, max_tokens: 2048 }
                };
            }
        }

        function parseProviderResponse(provider, result) {
            if (provider === 'gemini') {
                return result.candidates?.[0]?.content?.parts?.[0]?.text || '';
            } else {
                return result.choices?.[0]?.message?.content || '';
            }
        }

        function getProviderBlockReason(provider, result) {
            if (provider === 'gemini') {
                return result.candidates?.[0]?.finishReason || '';
            } else {
                return result.choices?.[0]?.finish_reason || '';
            }
        }

        window.openWashuChat = function() {
            if (!washuConfig.provider) {
                alert('Please configure an AI provider in Settings first.');
                openModal('settings');
                return;
            }
            openModal('washu');
            document.getElementById('washu-input').focus();
            // Scroll to bottom
            const msgArea = document.getElementById('washu-messages');
            msgArea.scrollTop = msgArea.scrollHeight;
        }

        window.clearWashuChat = function() {
            washuConversation = [];
            const msgArea = document.getElementById('washu-messages');
            msgArea.innerHTML = `
                <div class="flex gap-3">
                    <div class="bg-gradient-to-br from-fuchsia-500 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 shadow-md">
                        <i class="ph-fill ph-brain text-white text-sm"></i>
                    </div>
                    <div class="bg-slate-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-[85%] border border-slate-100">
                        <p class="text-sm text-slate-700 leading-relaxed">Fresh start! What would you like to know? My genius is at your disposal. ðŸ˜</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 ml-11">
                    <button onclick="askWashuQuick('What\\'s my biggest expense this month?')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Biggest expense?</button>
                    <button onclick="askWashuQuick('Am I on track to end the month positive?')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Am I on track?</button>
                    <button onclick="askWashuQuick('Summarize my financial situation across all months.')" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 px-3 py-1.5 rounded-full text-xs font-bold border border-fuchsia-200 transition-colors">Full summary</button>
                </div>`;
        }

        window.cancelWashuRequest = function() {
            if (washuAbortController) {
                washuAbortController.abort();
                washuAbortController = null;
            }
        }

        window.askWashuQuick = function(question) {
            document.getElementById('washu-input').value = question;
            handleWashuSubmit(new Event('submit', { cancelable: true }));
        }

        window.handleWashuSubmit = async function(e) {
            e.preventDefault();
            const input = document.getElementById('washu-input');
            const question = input.value.trim();
            if (!question || washuIsStreaming) return;
            input.value = '';

            const msgArea = document.getElementById('washu-messages');

            // Remove quick-action buttons if present
            const quickBtns = msgArea.querySelectorAll('.flex.flex-wrap.gap-2');
            quickBtns.forEach(el => el.remove());

            // Add user bubble
            const userDiv = document.createElement('div');
            userDiv.className = 'flex gap-3 justify-end';
            userDiv.innerHTML = `
                <div class="bg-gradient-to-r from-brand-500 to-brand-600 text-white rounded-2xl rounded-tr-md px-4 py-3 max-w-[85%] shadow-sm">
                    <p class="text-sm leading-relaxed">${escapeHtml(question)}</p>
                </div>`;
            msgArea.appendChild(userDiv);

            // Add Washu response placeholder
            const washuDiv = document.createElement('div');
            washuDiv.className = 'flex gap-3';
            washuDiv.innerHTML = `
                <div class="bg-gradient-to-br from-fuchsia-500 to-purple-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0 shadow-md">
                    <i class="ph-fill ph-brain text-white text-sm"></i>
                </div>
                <div class="bg-slate-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-[85%] border border-slate-100 washu-msg">
                    <p class="text-sm text-slate-500 leading-relaxed italic" id="washu-streaming-target"><i class="ph-bold ph-spinner washu-spinner mr-1.5"></i>Washu is thinking...</p>
                    <button onclick="cancelWashuRequest()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 mt-1.5 transition-colors" id="washu-cancel-btn">Cancel</button>
                </div>`;
            msgArea.appendChild(washuDiv);
            msgArea.scrollTop = msgArea.scrollHeight;

            // Build conversation payload (neutral format)
            washuConversation.push({ role: 'user', content: question });

            await sendWashuRequest();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function simpleMarkdown(text) {
            // Bold: **text**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Inline code: `text`
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bullet points: lines starting with - or *
            text = text.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            // Numbered lists: lines starting with 1. 2. etc
            text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            // Paragraphs (double newline)
            text = text.replace(/\n\n/g, '</p><p class="text-sm text-slate-700 leading-relaxed">');
            // Single newlines to <br>
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        async function sendWashuRequest() {
            washuIsStreaming = true;
            const sendBtn = document.getElementById('washu-send-btn');
            const input = document.getElementById('washu-input');
            sendBtn.disabled = true;
            input.disabled = true;
            sendBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';

            const target = document.getElementById('washu-streaming-target');
            const msgArea = document.getElementById('washu-messages');
            let fullText = '';
            let payloadJson = '';
            let systemPromptLen = 0;
            let convoLen = 0;
            const { provider, endpoint, model, apiKey } = washuConfig;

            try {
                const systemPrompt = getWashuSystemPrompt();
                const req = buildProviderRequest(provider, endpoint, model, apiKey, systemPrompt, washuConversation);

                // AbortController with 60-second timeout that covers the ENTIRE request lifecycle
                const controller = new AbortController();
                washuAbortController = controller;
                const timeout = setTimeout(() => controller.abort(), 60000);
                startWashuTimer('Sent');
                payloadJson = JSON.stringify(req.body);
                systemPromptLen = systemPrompt.length;
                convoLen = JSON.stringify(washuConversation).length;
                const approxTokens = Math.ceil(payloadJson.length / 4);
                console.log(`Washu [${provider}] payload: ${payloadJson.length} chars (~${approxTokens} tokens), system prompt: ${systemPromptLen} chars, conversation: ${convoLen} chars`);

                const fetchOpts = {
                    method: 'POST',
                    headers: req.headers,
                    body: new Blob([payloadJson], { type: 'application/json' }),
                    signal: controller.signal
                };

                // Retry logic for 429 rate limits (up to 3 attempts with backoff)
                // Don't retry on quota exhaustion â€” only on temporary per-minute rate limits
                let response;
                const maxRetries = 3;
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    response = await fetch(req.url, fetchOpts);
                    if (response.status !== 429 || attempt === maxRetries) break;
                    // Peek at the error to see if it's quota exhaustion (don't retry those)
                    const peekBody = await response.clone().text();
                    if (peekBody.includes('exceeded') || peekBody.includes('quota') || peekBody.includes('billing')) break;
                    const waitSec = attempt * 3;
                    console.log(`Washu 429 rate-limited, retrying in ${waitSec}s (attempt ${attempt}/${maxRetries})`);
                    if (target) target.innerHTML = `<i class="ph-bold ph-spinner washu-spinner mr-1.5"></i>Rate-limited â€” retrying in ${waitSec}s...`;
                    await new Promise(r => setTimeout(r, waitSec * 1000));
                }

                if (!response.ok) {
                    clearTimeout(timeout);
                    const errBody = await response.text();
                    console.error('Washu API raw error:', response.status, errBody);
                    let apiMsg = '';
                    try {
                        const errJson = JSON.parse(errBody);
                        apiMsg = errJson?.error?.message || '';
                    } catch(_) {}
                    throw new Error(`API error ${response.status}: ${apiMsg || errBody.substring(0, 500)}`);
                }

                const result = await response.json();
                clearTimeout(timeout);
                fullText = parseProviderResponse(provider, result);

                if (!fullText) {
                    const blockReason = getProviderBlockReason(provider, result);
                    throw new Error(blockReason ? `Response blocked (${blockReason})` : 'Empty response from AI provider');
                }

                // Finalize â€” reset styling and render response
                startWashuTimer('Reply');
                target.className = 'text-sm text-slate-700 leading-relaxed';
                target.innerHTML = simpleMarkdown(fullText);
                msgArea.scrollTop = msgArea.scrollHeight;

                // Save to conversation history (neutral format)
                washuConversation.push({ role: 'assistant', content: fullText });

            } catch (err) {
                console.error('Washu API error:', err);
                startWashuTimer('Error');
                target.className = 'text-sm leading-relaxed';

                let errorMsg = 'Hmm, even a genius hits a snag sometimes. ';
                if (err.name === 'AbortError') {
                    errorMsg += 'Request was cancelled or timed out. Try again in a moment.';
                } else if (err.message.includes('API error 400')) {
                    const detail = err.message.replace('API error 400: ', '').substring(0, 300);
                    errorMsg += `Bad request â€” ${detail}`;
                } else if (err.message.includes('API error 401') || err.message.includes('API error 403')) {
                    errorMsg += 'Your API key seems invalid or unauthorized. Double-check it in Settings.';
                } else if (err.message.includes('API error 429')) {
                    const detail429 = err.message.replace('API error 429: ', '');
                    if (detail429.includes('exceeded') || detail429.includes('quota') || detail429.includes('billing')) {
                        errorMsg += 'Your free-tier daily quota with Google is used up. It resets at midnight Pacific time. You can also add billing at ai.google.dev to remove limits.';
                    } else {
                        errorMsg += `Temporary rate limit â€” wait a minute and try again. Provider says: "${detail429.substring(0, 200)}"`;
                    }
                } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                    errorMsg += `Could not reach the AI endpoint (${endpoint}). Check that the URL is correct and the service is running.`;
                } else {
                    errorMsg += err.message;
                }

                // Show diagnostics so we can debug persistent failures
                const diagLine = payloadJson
                    ? `<br><span class="text-xs text-slate-500 mt-2 block font-mono">provider: ${provider} | model: ${model} | payload: ${payloadJson.length} chars (~${Math.ceil(payloadJson.length / 4)} tokens) | prompt: ${systemPromptLen} chars | convo: ${convoLen} chars</span>`
                    : '';

                target.innerHTML = `<span class="text-rose-600">${errorMsg}</span>${diagLine}`;
                // Remove the failed message from conversation
                washuConversation.pop();
            } finally {
                // Remove the ID so future messages don't collide with this element
                if (target) target.removeAttribute('id');
                // Hide cancel button
                const cancelBtn = document.getElementById('washu-cancel-btn');
                if (cancelBtn) cancelBtn.remove();
                washuAbortController = null;
                washuIsStreaming = false;
                sendBtn.disabled = false;
                input.disabled = false;
                sendBtn.innerHTML = '<i class="ph-bold ph-paper-plane-tilt"></i>';
                input.focus();
            }
        }

        // --- INIT: Must run AFTER all window.xxx assignments above ---
        setupWeeklyCheckboxes();
        setupMonthlyGrid();
        updateCategoryOptions('txn-category', 'withdrawal');
        updateCategoryOptions('tpl-category', 'withdrawal');
    </script>
</body>
</html>

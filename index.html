<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUFT - BakaNeko's Ultimate Finance Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
                        ledger: { highlight: '#f1f5f9' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f7f9; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hide { display: none !important; }
        .item-cleared td { opacity: 0.4; transition: opacity 0.3s ease; }
        .item-cleared .item-name, .item-cleared .item-amount { text-decoration: line-through; }
        .day-checkbox input:checked + div { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox { right: 4px; z-index: 1; transition: all 0.3s; }
        .toggle-label { transition: all 0.3s; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden antialiased">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-10 rounded-3xl shadow-2xl flex flex-col items-center max-w-md w-[90%] text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-brand-50 opacity-50"></div>
            <div class="relative z-10 flex flex-col items-center">
                <div class="bg-brand-600 p-4 rounded-2xl shadow-xl shadow-brand-500/30 mb-6">
                    <svg viewBox="0 0 120 100" class="w-20 h-20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 20 55 C 15 80, 30 95, 60 95 C 90 95, 105 80, 100 55 C 95 30, 90 25, 80 5 L 70 30 C 65 28, 55 28, 50 30 L 40 5 C 30 25, 25 30, 20 55 Z" fill="white" stroke="#2d1b19" stroke-width="4" stroke-linejoin="round"/>
                        <path d="M 35 48 L 45 53 L 35 58 M 85 48 L 75 53 L 85 58" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M 5 50 L 25 53 M 2 60 L 23 60 M 7 70 L 26 67 M 115 50 L 95 53 M 118 60 L 97 60 M 113 70 L 94 67" fill="none" stroke="#2d1b19" stroke-width="3" stroke-linecap="round"/>
                        <path d="M 48 65 Q 54 72 60 65 Q 66 72 72 65" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/>
                        <path d="M 52 68 C 52 88, 68 88, 68 68 Z" fill="#fbcfe8" stroke="#2d1b19" stroke-width="3"/>
                        <circle cx="32" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/><circle cx="88" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">Welcome to BUFT</h1>
                <p class="text-sm text-slate-500 font-medium mb-8">BakaNeko's Ultimate Finance Tool</p>
                <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 px-6 py-3.5 rounded-xl font-bold shadow-sm transition-all transform hover:scale-105">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google"> Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-app" class="flex w-full h-full opacity-0 transition-opacity duration-500 hide">
        
        <!-- ACCESS VERIFICATION GATE (The Bouncer) -->
        <div id="access-gate-overlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-md z-[150] flex flex-col items-center justify-center hidden opacity-0 transition-all duration-300">
            <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col max-w-lg w-[90%] border-t-8 border-brand-500">
                <div class="flex items-center mb-6">
                    <div class="bg-brand-100 p-3 rounded-full mr-4"><i class="ph-fill ph-shield-check text-3xl text-brand-600"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Private Access Required</h2><p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Disclaimer & Verification</p></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 text-sm text-slate-600 leading-relaxed">
                    <p class="mb-3">This is a private, self-hosted instance of BUFT. Data is stored on owner's private cloud.</p>
                    <p>Contact the owner for the access code at <a href="mailto:bakaneko@bakeaneko.net" class="font-bold text-brand-600 hover:underline">bakaneko@bakeaneko.net</a>.</p>
                </div>
                <form onsubmit="verifyAccessCode(event)" class="space-y-4">
                    <input type="text" id="access-code-input" required placeholder="Enter code..." class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-center font-bold tracking-widest uppercase focus:border-brand-500 outline-none">
                    <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-md">Acknowledge & Enter</button>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex shadow-sm z-10">
            <div class="h-28 flex items-center justify-center border-b border-slate-100">
                <span class="text-3xl font-extrabold text-slate-900 hidden lg:block">BUFT</span>
                <i class="ph-bold ph-cat text-3xl text-brand-600 lg:hidden"></i>
            </div>
            <nav class="flex-1 p-4 space-y-2 flex flex-col">
                <button onclick="switchTab('ledger')" id="nav-ledger" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl bg-brand-50 text-brand-600 font-bold"><i class="ph-bold ph-list-numbers text-xl"></i><span class="hidden lg:block">Ledger</span></button>
                <button onclick="switchTab('templates')" id="nav-templates" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:text-slate-900 font-bold"><i class="ph-bold ph-calendar-plus text-xl"></i><span class="hidden lg:block">Templates</span></button>
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:text-slate-900 font-bold"><i class="ph-bold ph-chart-polar text-xl"></i><span class="hidden lg:block">Insights</span></button>
                <button onclick="logoutUser()" class="mt-auto w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-400 hover:text-rose-600 font-bold"><i class="ph-bold ph-sign-out text-xl"></i><span class="hidden lg:block">Sign Out</span></button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-8 shrink-0 z-10">
                <div class="flex items-center gap-4">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 rounded-full"><i class="ph-bold ph-caret-left"></i></button>
                    <h2 id="current-month-display" class="font-bold text-slate-800 w-36 text-center">Loading...</h2>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 rounded-full"><i class="ph-bold ph-caret-right"></i></button>
                </div>
                <div class="flex items-center gap-6">
                    <div class="bg-slate-50 px-4 py-2 rounded-full border border-slate-200 flex items-center">
                        <span class="text-slate-400 font-bold mr-2">$</span>
                        <input type="number" id="manual-bank-balance" class="font-extrabold text-slate-800 w-24 outline-none bg-transparent" onchange="updateBankBalance(this.value)">
                    </div>
                    <button onclick="openTransactionModal()" class="bg-slate-900 hover:bg-brand-600 text-white px-5 py-2.5 rounded-full font-bold shadow-lg shadow-slate-900/20 flex items-center">
                        <i class="ph-bold ph-plus mr-2"></i> Add Item
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 relative" id="main-scroll-area">
                <div id="data-loader" class="absolute inset-0 bg-[#f4f7f9] z-50 flex flex-col items-center justify-center">
                    <i class="ph-bold ph-spinner animate-spin text-4xl text-brand-500 mb-4"></i>
                    <span class="text-slate-500 font-bold tracking-widest uppercase text-xs">Syncing Cloud Ledger...</span>
                </div>

                <!-- LEDGER VIEW -->
                <div id="view-ledger" class="max-w-7xl mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Remaining Impact</span><div id="metric-remaining" class="text-3xl font-extrabold text-slate-900 mt-1">$0.00</div></div>
                        <div class="bg-slate-900 p-6 rounded-3xl shadow-xl text-white"><span class="text-xs font-bold text-slate-300 uppercase tracking-wider">Projected EOM</span><div id="metric-projected" class="text-3xl font-extrabold mt-1 text-emerald-400">$0.00</div></div>
                    </div>
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead><tr class="bg-slate-50 border-b border-slate-100 text-[11px] font-bold uppercase text-slate-400 tracking-wider"><th class="py-4 px-6">Date</th><th class="py-4 px-6">Item</th><th class="py-4 px-6">Category</th><th class="py-4 px-6 text-right">Amount</th><th class="py-4 px-6 text-center">Status</th><th class="py-4 px-6 text-right">Running Total</th><th class="py-4 px-6"></th></tr></thead>
                            <tbody id="ledger-body" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TEMPLATES VIEW -->
                <div id="view-templates" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="flex justify-between items-center bg-white p-6 rounded-3xl border border-slate-200"><h2 class="text-2xl font-extrabold text-slate-900">Recurring Rules</h2><button onclick="openTemplateModal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold">New Rule</button></div>
                    <div id="templates-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <!-- INSIGHTS VIEW -->
                <div id="view-dashboard" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200">
                        <h2 class="text-2xl font-extrabold text-slate-900 mb-6">Cash Flow Analysis</h2>
                        <div class="h-64"><canvas id="cashflowChart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="modal-transaction" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-all duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-extrabold text-lg text-slate-800">Add Ledger Entry</h3>
                <button onclick="closeModal('transaction')" class="text-slate-400 hover:text-slate-700"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <form onsubmit="handleTransactionSubmit(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Date</label><input type="date" id="txn-date" required class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none bg-slate-50"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Type</label><select id="txn-type" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none font-bold bg-white"><option value="withdrawal">Withdrawal (-)</option><option value="deposit">Deposit (+)</option></select></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Description</label><input type="text" id="txn-name" required placeholder="e.g., Groceries" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Amount ($)</label><input type="number" step="0.01" id="txn-amount" required class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none font-bold"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Category</label><select id="txn-category" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none bg-white"><option value="Home">Home</option><option value="Services">Services</option><option value="Subscription">Subscription</option><option value="Auto">Auto</option><option value="Other">Other</option></select></div>
                </div>
                <div class="pt-4 flex justify-end space-x-3 border-t border-slate-100 mt-2">
                    <button type="button" onclick="closeModal('transaction')" class="px-5 py-2.5 text-slate-600 font-bold">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-slate-900 text-white rounded-xl font-bold shadow-md">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE CLOUD ENGINE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkZHoWGByIZXzFSGjrZMHgEytwdqyZLqE",
            authDomain: "buft-b0d7f.firebaseapp.com",
            projectId: "buft-b0d7f",
            storageBucket: "buft-b0d7f.firebasestorage.app",
            messagingSenderId: "724127677004",
            appId: "1:724127677004:web:080d212affb3cb87ccd2e9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let dataLoaded = { settings: false, txns: false, tpls: false };
        let hasInitializedCore = false;
        let cashflowChart = null;
        const REAL_CURRENT_DATE = new Date();

        window.state = { currentDate: new Date(REAL_CURRENT_DATE), bankBalance: 0, initializedMonths: [], transactions: [], templates: [], hasAcceptedTerms: false };

        // AUTH LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('hide');
                    document.getElementById('main-app').classList.remove('hide');
                    setTimeout(() => document.getElementById('main-app').classList.remove('opacity-0'), 50);
                }, 500);
                setupCloudSync();
            } else {
                currentUser = null;
                document.getElementById('login-overlay').classList.remove('hide');
                document.getElementById('main-app').classList.add('hide');
            }
        });

        window.loginWithGoogle = () => { signInWithPopup(auth, new GoogleAuthProvider()); };
        window.logoutUser = () => signOut(auth);

        // CLOUD SYNC
        async function setupCloudSync() {
            const uid = currentUser.uid;
            
            // Check for initial existence of settings to prevent "Loading" hang
            const settingsRef = doc(db, 'users', uid, 'settings', 'main');
            const snap = await getDoc(settingsRef);
            if (!snap.exists()) {
                // Self-Healing: Create initial record if missing
                await setDoc(settingsRef, { bankBalance: 0, initializedMonths: [], hasAcceptedTerms: false });
            }

            onSnapshot(settingsRef, (docSnap) => {
                if(docSnap.exists()) {
                    state.bankBalance = docSnap.data().bankBalance || 0;
                    state.initializedMonths = docSnap.data().initializedMonths || [];
                    state.hasAcceptedTerms = docSnap.data().hasAcceptedTerms || false;
                }
                dataLoaded.settings = true;
                checkReadyToInit();
            });

            onSnapshot(collection(db, 'users', uid, 'templates'), (snapshot) => {
                let tpls = []; snapshot.forEach(doc => tpls.push(doc.data()));
                state.templates = tpls; dataLoaded.tpls = true; checkReadyToInit();
            });

            onSnapshot(collection(db, 'users', uid, 'transactions'), (snapshot) => {
                let txns = []; snapshot.forEach(doc => txns.push(doc.data()));
                state.transactions = txns; dataLoaded.txns = true; checkReadyToInit();
            });
        }

        async function checkReadyToInit() {
            if (dataLoaded.settings && dataLoaded.txns && dataLoaded.tpls) {
                if (!hasInitializedCore) {
                    if (!state.hasAcceptedTerms) {
                        document.getElementById('data-loader').classList.add('hidden');
                        const gate = document.getElementById('access-gate-overlay');
                        gate.classList.remove('hidden');
                        setTimeout(() => gate.classList.remove('opacity-0'), 10);
                        return;
                    }
                    completeInitialization();
                } else {
                    renderApp();
                }
            }
        }

        window.completeInitialization = async function() {
            hasInitializedCore = true;
            document.getElementById('data-loader').classList.add('hidden');
            const gate = document.getElementById('access-gate-overlay');
            gate.classList.add('opacity-0'); setTimeout(() => gate.classList.add('hidden'), 300);
            
            // Auto-init current month
            const mKey = `${state.currentDate.getFullYear()}-${(state.currentDate.getMonth()+1).toString().padStart(2,'0')}`;
            if (!state.initializedMonths.includes(mKey)) {
                state.initializedMonths.push(mKey);
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { initializedMonths: state.initializedMonths }, { merge: true });
            }
            renderApp();
        }

        window.verifyAccessCode = async (e) => {
            e.preventDefault();
            if (document.getElementById('access-code-input').value.toUpperCase() === 'L337') {
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { hasAcceptedTerms: true }, { merge: true });
                state.hasAcceptedTerms = true;
                completeInitialization();
            } else alert("Invalid Code");
        }

        // RENDERING
        window.renderApp = () => {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-display').innerText = `${months[state.currentDate.getMonth()]} ${state.currentDate.getFullYear()}`;
            document.getElementById('manual-bank-balance').value = state.bankBalance.toFixed(2);
            
            const tbody = document.getElementById('ledger-body');
            tbody.innerHTML = '';
            
            const mKey = `${state.currentDate.getFullYear()}-${(state.currentDate.getMonth()+1).toString().padStart(2,'0')}`;
            const monthTxns = state.transactions.filter(t => t.date.startsWith(mKey)).sort((a,b) => new Date(a.date) - new Date(b.date));
            
            let runningTotal = 0; let remaining = 0; let income = 0; let expense = 0;
            
            if (monthTxns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="py-12 text-center text-slate-400 italic font-medium">No ledger entries for this month.</td></tr>`;
            }

            monthTxns.forEach(t => {
                if (t.type === 'deposit') { runningTotal += t.amount; income += t.amount; if(t.status !== 'cleared') remaining += t.amount; }
                else { runningTotal -= t.amount; expense += t.amount; if(t.status !== 'cleared') remaining -= t.amount; }
                
                const tr = document.createElement('tr');
                tr.className = `border-b border-slate-50 hover:bg-slate-50/50 transition-colors group ${t.status === 'cleared' ? 'item-cleared' : ''}`;
                tr.innerHTML = `
                    <td class="py-4 px-6 font-medium text-slate-500">${t.date.split('-')[2]}</td>
                    <td class="py-4 px-6 font-bold text-slate-800">${t.name}</td>
                    <td class="py-4 px-6"><span class="bg-slate-100 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider text-slate-600">${t.category}</span></td>
                    <td class="py-4 px-6 text-right font-extrabold ${t.type === 'deposit' ? 'text-emerald-600' : 'text-slate-900'}">${t.type === 'deposit' ? '+' : ''}$${t.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="py-4 px-6 text-center">
                        <select onchange="updateStatus('${t.id}', this.value)" class="text-[10px] font-bold uppercase border border-slate-200 rounded-full px-4 py-1.5 outline-none appearance-none cursor-pointer bg-white shadow-sm text-center">
                            <option value="unprocessed" ${t.status === 'unprocessed' ? 'selected' : ''}>Uncleared</option>
                            <option value="cleared" ${t.status === 'cleared' ? 'selected' : ''}>Cleared</option>
                        </select>
                    </td>
                    <td class="py-4 px-6 text-right font-extrabold bg-slate-50/30">$${runningTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="py-4 px-6 text-center">
                        <button onclick="deleteTxn('${t.id}')" class="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash text-lg"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('metric-remaining').innerText = (remaining >= 0 ? '+' : '-') + '$' + Math.abs(remaining).toLocaleString(undefined, {minimumFractionDigits: 2});
            const projected = state.bankBalance + remaining;
            const projectedEl = document.getElementById('metric-projected');
            projectedEl.innerText = '$' + projected.toLocaleString(undefined, {minimumFractionDigits: 2});
            projectedEl.className = projected < 0 ? 'text-3xl font-extrabold mt-1 text-rose-400' : 'text-3xl font-extrabold mt-1 text-emerald-400';

            renderTemplates();
            renderCharts(income, expense);
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            container.innerHTML = '';
            state.templates.forEach(tpl => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between";
                div.innerHTML = `
                    <div>
                        <div class="flex justify-between mb-4"><span class="bg-brand-50 text-brand-600 px-2 py-1 rounded text-[10px] font-bold uppercase">${tpl.category}</span></div>
                        <h3 class="font-bold text-slate-800 text-lg mb-1">${tpl.name}</h3>
                        <div class="text-2xl font-extrabold text-slate-900">$${tpl.amount.toFixed(2)}</div>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="deleteTemplate('${tpl.id}')" class="text-slate-400 hover:text-rose-600"><i class="ph-bold ph-trash text-lg"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderCharts(income, expense) {
            const ctx = document.getElementById('cashflowChart').getContext('2d');
            if (cashflowChart) cashflowChart.destroy();
            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Deposits', 'Withdrawals'], datasets: [{ data: [income, expense], backgroundColor: ['#10b981', '#f43f5e'], borderRadius: 12 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // HELPERS
        window.switchTab = (tab) => {
            ['ledger', 'templates', 'dashboard'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hide');
                document.getElementById(`nav-${t}`).classList.remove('bg-brand-50', 'text-brand-600');
                document.getElementById(`nav-${t}`).classList.add('text-slate-500');
            });
            document.getElementById(`view-${tab}`).classList.remove('hide');
            document.getElementById(`nav-${tab}`).classList.add('bg-brand-50', 'text-brand-600');
            renderApp();
        };

        window.updateStatus = (id, status) => setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), { status }, { merge: true });
        window.deleteTxn = (id) => { if(confirm("Delete this entry?")) deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id)); };
        window.updateBankBalance = (val) => setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { bankBalance: parseFloat(val) }, { merge: true });
        window.changeMonth = (delta) => { state.currentDate.setMonth(state.currentDate.getMonth() + delta); renderApp(); };
        window.openTransactionModal = () => { 
            const d = new Date(); document.getElementById('txn-date').value = d.toISOString().split('T')[0];
            document.getElementById('modal-transaction').classList.remove('hidden'); document.getElementById('modal-transaction').classList.add('flex'); setTimeout(() => { document.getElementById('modal-transaction').classList.remove('opacity-0'); document.getElementById('modal-transaction').querySelector('div').classList.remove('scale-95'); }, 10); 
        };
        window.closeModal = (id) => { document.getElementById('modal-' + id).classList.add('opacity-0'); document.getElementById('modal-' + id).querySelector('div').classList.add('scale-95'); setTimeout(() => document.getElementById('modal-' + id).classList.add('hidden'), 300); };
        window.handleTransactionSubmit = async (e) => {
            e.preventDefault();
            const id = 't_' + Date.now();
            const txn = { id, date: document.getElementById('txn-date').value, name: document.getElementById('txn-name').value, amount: parseFloat(document.getElementById('txn-amount').value), type: document.getElementById('txn-type').value, category: document.getElementById('txn-category').value, status: 'unprocessed' };
            await setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), txn);
            closeModal('transaction');
        };
    </script>
</body>
</html>


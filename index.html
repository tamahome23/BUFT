<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUFT - BakaNeko's Ultimate Finance Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
                        ledger: { highlight: '#f1f5f9' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f7f9; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .hide { display: none !important; }
        
        .item-cleared td { opacity: 0.4; transition: opacity 0.3s ease; }
        .item-cleared:hover td { opacity: 0.65; }
        .item-cleared .item-name, .item-cleared .item-amount { text-decoration: line-through; }
        
        .day-checkbox input:checked + div { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-checkbox { right: 4px; z-index: 1; transition: all 0.3s; }
        .toggle-label { transition: all 0.3s; }

        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden antialiased">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-10 rounded-3xl shadow-2xl flex flex-col items-center max-w-md w-[90%] text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-brand-50 opacity-50"></div>
            <div class="relative z-10 flex flex-col items-center">
                <div class="bg-brand-600 p-4 rounded-2xl shadow-xl shadow-brand-500/30 mb-6">
                    <svg viewBox="0 0 120 100" class="w-20 h-20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 20 55 C 15 80, 30 95, 60 95 C 90 95, 105 80, 100 55 C 95 30, 90 25, 80 5 L 70 30 C 65 28, 55 28, 50 30 L 40 5 C 30 25, 25 30, 20 55 Z" fill="white" stroke="#2d1b19" stroke-width="4" stroke-linejoin="round"/>
                        <path d="M 35 48 L 45 53 L 35 58 M 85 48 L 75 53 L 85 58" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M 5 50 L 25 53 M 2 60 L 23 60 M 7 70 L 26 67 M 115 50 L 95 53 M 118 60 L 97 60 M 113 70 L 94 67" fill="none" stroke="#2d1b19" stroke-width="3" stroke-linecap="round"/>
                        <path d="M 48 65 Q 54 72 60 65 Q 66 72 72 65" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/>
                        <path d="M 52 68 C 52 88, 68 88, 68 68 Z" fill="#fbcfe8" stroke="#2d1b19" stroke-width="3"/>
                        <circle cx="32" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                        <circle cx="88" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">Welcome to BUFT</h1>
                <p class="text-sm text-slate-500 font-medium mb-8">BakaNeko's Ultimate Finance Tool</p>
                <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 px-6 py-3.5 rounded-xl font-bold shadow-sm transition-all transform hover:scale-105">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-app" class="flex w-full h-full opacity-0 transition-opacity duration-500 hide">
        
        <!-- ACCESS VERIFICATION GATE (Bouncer) -->
        <div id="access-gate-overlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-md z-[150] flex flex-col items-center justify-center hidden opacity-0 transition-all duration-300">
            <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col max-w-lg w-[90%] relative overflow-hidden border-t-8 border-brand-500">
                <div class="flex items-center mb-6">
                    <div class="bg-brand-100 p-3 rounded-full mr-4"><i class="ph-fill ph-shield-check text-3xl text-brand-600"></i></div>
                    <div><h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Private Access Required</h2><p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Disclaimer & Verification</p></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 text-sm text-slate-600 leading-relaxed">
                    <p class="mb-3">This is a private, self-hosted instance of BUFT. Access requires acknowledge of data storage on the owner's private cloud. Code: L337</p>
                    <p>Contact the owner for the code at <a href="mailto:bakaneko@bakeaneko.net" class="font-bold text-brand-600 hover:underline">bakaneko@bakeaneko.net</a>.</p>
                </div>
                <form onsubmit="verifyAccessCode(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase tracking-wider mb-2">Enter Invite Code</label>
                        <input type="text" id="access-code-input" required autocomplete="off" placeholder="Enter code here..." class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 outline-none text-slate-900 font-bold text-center tracking-widest uppercase focus:border-brand-500 transition-colors">
                        <p id="access-error" class="text-rose-500 text-xs font-bold mt-2 text-center hidden"><i class="ph-bold ph-warning-circle mr-1"></i>Invalid access code.</p>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="logoutUser()" class="w-1/3 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-bold transition-colors">Cancel</button>
                        <button type="submit" class="w-2/3 bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-md transition-all">Acknowledge & Enter</button>
                    </div>
                </form>
            </div>
        </div>

        <aside class="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            <div class="h-28 flex flex-col items-center justify-center border-b border-slate-100 px-4">
                <div class="group relative flex flex-col items-center cursor-help">
                    <div class="flex items-center">
                        <div class="relative drop-shadow-sm transition-transform hover:scale-105">
                            <svg viewBox="0 0 120 100" class="w-14 h-14" xmlns="http://www.w3.org/2000/svg">
                                <path d="M 20 55 C 15 80, 30 95, 60 95 C 90 95, 105 80, 100 55 C 95 30, 90 25, 80 5 L 70 30 C 65 28, 55 28, 50 30 L 40 5 C 30 25, 25 30, 20 55 Z" fill="white" stroke="#2d1b19" stroke-width="4" stroke-linejoin="round"/><path d="M 35 48 L 45 53 L 35 58 M 85 48 L 75 53 L 85 58" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/><path d="M 5 50 L 25 53 M 2 60 L 23 60 M 7 70 L 26 67 M 115 50 L 95 53 M 118 60 L 97 60 M 113 70 L 94 67" fill="none" stroke="#2d1b19" stroke-width="3" stroke-linecap="round"/><path d="M 48 65 Q 54 72 60 65 Q 66 72 72 65" fill="none" stroke="#2d1b19" stroke-width="4" stroke-linecap="round"/><path d="M 52 68 C 52 88, 68 88, 68 68 Z" fill="#fbcfe8" stroke="#2d1b19" stroke-width="3"/><circle cx="32" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/><circle cx="88" cy="85" r="14" fill="white" stroke="#2d1b19" stroke-width="4"/>
                            </svg>
                        </div>
                        <span class="text-3xl font-extrabold text-slate-900 ml-3 hidden lg:block tracking-tight">BUFT</span>
                    </div>
                    <span class="text-[9px] font-bold text-slate-400 mt-2 hidden lg:block uppercase tracking-widest text-center leading-tight">BakaNeko's Ultimate Finance Tool</span>
                    <div class="absolute left-full lg:left-auto lg:top-full lg:mt-2 ml-4 lg:ml-0 w-max px-3 py-2 bg-slate-900 text-white text-[11px] font-bold rounded-lg opacity-0 group-hover:opacity-100 transition-all pointer-events-none z-[100] shadow-xl transform scale-95 group-hover:scale-100">Created by Paul Bienvenu (aka BakaNeko)</div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 mt-4 flex flex-col">
                <button onclick="switchTab('ledger')" id="nav-ledger" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl bg-brand-50 text-brand-600 font-semibold transition-all"><i class="ph-bold ph-list-numbers text-2xl lg:text-xl"></i><span class="hidden lg:block">Ledger</span></button>
                <button onclick="switchTab('templates')" id="nav-templates" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-semibold transition-all"><i class="ph-bold ph-calendar-plus text-2xl lg:text-xl"></i><span class="hidden lg:block">Templates</span></button>
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-semibold transition-all"><i class="ph-bold ph-chart-polar text-2xl lg:text-xl"></i><span class="hidden lg:block">Insights</span></button>
                <div class="mt-auto pt-4 border-t border-slate-100"><button onclick="logoutUser()" class="w-full flex items-center justify-center lg:justify-start space-x-3 px-4 py-3.5 rounded-xl text-slate-400 hover:bg-rose-50 hover:text-rose-600 font-semibold transition-all"><i class="ph-bold ph-sign-out text-2xl lg:text-xl"></i><span class="hidden lg:block">Sign Out</span></button></div>
            </nav>
        </aside>

        <!-- Mobile Nav -->
        <div class="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-around p-2 pb-safe z-50 shadow-[0_-4px_24px_rgba(0,0,0,0.05)]">
            <button onclick="switchTab('ledger')" class="flex flex-col items-center p-2 text-brand-600"><i class="ph-bold ph-list-numbers text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Ledger</span></button>
            <button onclick="switchTab('templates')" class="flex flex-col items-center p-2 text-slate-400"><i class="ph-bold ph-calendar-plus text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Templates</span></button>
            <button onclick="switchTab('dashboard')" class="flex flex-col items-center p-2 text-slate-400"><i class="ph-bold ph-chart-polar text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase tracking-wider">Insights</span></button>
        </div>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 lg:px-8 shrink-0 z-10">
                <div class="flex items-center gap-2 lg:gap-4">
                    <div class="flex items-center bg-slate-100 rounded-full p-1 border border-slate-200 shadow-sm">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition-colors text-slate-500"><i class="ph-bold ph-caret-left"></i></button>
                        <h2 id="current-month-display" class="text-sm lg:text-base font-bold w-32 lg:w-36 text-center text-slate-800 tracking-tight">Loading...</h2>
                        <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition-colors text-slate-500"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <button onclick="goToToday()" class="px-3.5 py-1.5 bg-brand-50 hover:bg-brand-100 text-brand-600 rounded-full text-[10px] lg:text-xs font-bold uppercase tracking-wider hidden sm:block border border-brand-100">Today</button>
                </div>
                <div class="flex items-center gap-3 lg:gap-6">
                    <div class="flex items-center bg-slate-50 px-4 py-2 rounded-full border border-slate-200 shadow-sm">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mr-2 hidden md:block">Bank:</span>
                        <span class="text-slate-400 font-bold">$</span>
                        <input type="number" id="manual-bank-balance" class="font-extrabold text-slate-800 w-24 outline-none bg-transparent" onchange="updateBankBalance(this.value)">
                    </div>
                    <button onclick="openTransactionModal()" class="bg-slate-900 hover:bg-brand-600 text-white p-2 lg:px-5 lg:py-2.5 rounded-full font-semibold shadow-lg transition-all flex items-center">
                        <i class="ph-bold ph-plus lg:mr-2 text-xl lg:text-base"></i> <span class="hidden lg:inline">Add Item</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 lg:p-8 pb-28 md:pb-8 scroll-smooth relative" id="main-scroll-area">
                <div id="data-loader" class="absolute inset-0 bg-[#f4f7f9] z-50 flex flex-col items-center justify-center">
                    <i class="ph-bold ph-spinner animate-spin text-4xl text-brand-500 mb-4"></i>
                    <span class="text-slate-500 font-bold tracking-widest uppercase text-xs">Syncing Ledger...</span>
                </div>

                <div id="view-ledger" class="max-w-7xl mx-auto space-y-6">
                    <div id="archival-notice" class="bg-amber-50 border border-amber-200 text-amber-800 px-4 py-3 rounded-xl flex items-center hide shadow-sm">
                        <i class="ph-fill ph-lock-key text-xl mr-3"></i>
                        <span class="text-sm font-bold">Historical View: This month is in the past. Template changes will not alter these records.</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center relative overflow-hidden"><div class="absolute top-0 right-0 p-4 opacity-5 text-slate-400"><i class="ph-fill ph-hourglass-high text-7xl"></i></div><span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 z-10">Remaining to Process</span><div id="metric-remaining" class="text-3xl font-extrabold text-slate-900 mt-1 tracking-tight z-10">$0.00</div></div>
                        <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-3xl shadow-xl flex flex-col justify-center relative overflow-hidden text-white"><div class="absolute top-0 right-0 p-4 opacity-10"><i class="ph-fill ph-check-circle text-7xl"></i></div><span class="text-xs font-bold text-slate-300 uppercase tracking-wider mb-2 z-10">Projected EOM Balance</span><div id="metric-projected" class="text-3xl font-extrabold mt-1 tracking-tight z-10 text-emerald-400">$0.00</div></div>
                    </div>
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead><tr class="bg-slate-50/50 border-b border-slate-200 text-[11px] font-bold uppercase text-slate-400 tracking-wider"><th class="py-4 px-6 w-24">Date</th><th class="py-4 px-6">Item</th><th class="py-4 px-6">Category</th><th class="py-4 px-6 text-right">Amount</th><th class="py-4 px-6 text-center w-40">Status</th><th class="py-4 px-6 text-right w-36 bg-ledger-highlight/50 text-slate-500">Running Total</th><th class="py-4 px-4 text-center w-24"></th></tr></thead>
                                <tbody id="ledger-body" class="text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-templates" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-3xl border border-slate-200 shadow-sm gap-4">
                        <div><h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Recurring Rules</h2><p class="text-slate-500 text-sm mt-1">Changes affect future months.</p></div>
                        <div class="flex items-center space-x-4 w-full md:w-auto">
                            <div class="bg-slate-100 p-1 rounded-xl flex">
                                <button onclick="setTemplateView('category')" id="btn-view-cat" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-brand-600 shadow-sm transition-all">By Category</button>
                                <button onclick="setTemplateView('recurrence')" id="btn-view-rec" class="px-3 py-1.5 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">By Recurrence</button>
                            </div>
                            <button onclick="openTemplateModal()" class="flex-1 md:flex-none justify-center bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-brand-500/30 flex items-center transition-all"><i class="ph-bold ph-plus mr-2"></i> New</button>
                        </div>
                    </div>
                    <div id="templates-container" class="space-y-8"></div>
                </div>

                <div id="view-dashboard" class="max-w-7xl mx-auto hide space-y-6">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200"><h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Monthly Insights</h2></div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"><h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-trend-up text-brand-500 mr-2 text-xl"></i> Running Impact Trend</h3><div class="relative h-64 w-full"><canvas id="balanceTrendChart"></canvas></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"><h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-scales text-brand-500 mr-2 text-xl"></i> Cash Flow</h3><div class="relative h-64 w-full"><canvas id="cashflowChart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm"><h3 class="font-bold text-slate-800 mb-6 flex items-center"><i class="ph-fill ph-chart-pie-slice text-brand-500 mr-2 text-xl"></i> Withdrawals by Category</h3><div class="relative h-64 w-full flex justify-center"><canvas id="categoryChart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-transaction" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-extrabold text-lg text-slate-800">Ledger Entry</h3>
                <button onclick="closeModal('transaction')" class="text-slate-400 hover:text-slate-700 bg-white hover:bg-slate-100 rounded-full p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <form onsubmit="handleTransactionSubmit(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="txn-date" required class="border border-slate-200 rounded-xl px-4 py-2.5 outline-none bg-slate-50">
                    <select id="txn-type" onchange="updateCategoryOptions('txn-category', this.value)" class="border border-slate-200 rounded-xl px-4 py-2.5 outline-none font-bold bg-white"><option value="withdrawal">Withdrawal</option><option value="deposit">Deposit</option></select>
                </div>
                <input type="text" id="txn-name" required placeholder="Description" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.01" id="txn-amount" required placeholder="Amount" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none font-bold">
                    <select id="txn-category" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none bg-white"></select>
                </div>
                <input type="text" id="txn-comment" placeholder="Optional note" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none text-sm">
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg mt-2">Save Item</button>
            </form>
        </div>
    </div>

    <div id="modal-comment" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[110] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-brand-50"><h3 class="font-extrabold text-lg text-brand-900"><i class="ph-fill ph-chat-text mr-2 text-brand-600"></i>Line Comment</h3><button onclick="closeModal('comment')" class="text-brand-400 hover:text-brand-700"><i class="ph-bold ph-x text-lg"></i></button></div>
            <div class="p-6"><input type="hidden" id="edit-comment-id"><textarea id="edit-comment-text" rows="3" class="w-full border border-slate-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-brand-500 mb-4" placeholder="Add your freehand notes here..."></textarea><div class="flex justify-end space-x-3"><button type="button" onclick="closeModal('comment')" class="px-4 py-2 text-slate-600 font-bold">Cancel</button><button type="button" onclick="saveLedgerComment()" class="px-4 py-2 bg-brand-600 text-white rounded-xl font-bold shadow-md">Save Note</button></div></div>
        </div>
    </div>

    <div id="modal-template" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[100] px-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0"><h3 class="font-extrabold text-lg text-slate-800" id="tpl-modal-title">New Rule</h3><button onclick="closeModal('template')" class="text-slate-400 hover:text-slate-700 p-1.5 transition-colors"><i class="ph-bold ph-x text-lg"></i></button></div>
            <form id="form-template" onsubmit="handleTemplateSubmit(event)" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="tpl-id">
                <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-200"><div><span class="block text-sm font-bold text-slate-800">Auto-Processing</span><span class="block text-[11px] font-medium text-slate-500 mt-0.5">Automatically clears when date passes</span></div><div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="tpl-autoprocess" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="tpl-autoprocess" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div>
                <input type="text" id="tpl-name" required placeholder="Netflix" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none">
                <div class="grid grid-cols-2 gap-4"><select id="tpl-type" onchange="updateCategoryOptions('tpl-category', this.value)" class="border border-slate-200 rounded-xl px-4 py-2.5 font-bold outline-none"><option value="withdrawal">Withdrawal</option><option value="deposit">Deposit</option></select><input type="number" step="0.01" id="tpl-amount" required placeholder="Amount" class="border border-slate-200 rounded-xl px-4 py-2.5 font-bold outline-none"></div>
                <select id="tpl-category" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 outline-none"></select>
                <textarea id="tpl-details" rows="2" placeholder="Rule Details" class="w-full border border-slate-200 rounded-xl p-3 outline-none text-sm"></textarea>
                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <label class="block text-xs font-bold text-slate-700 uppercase mb-3 tracking-wider">Recurrence Pattern</label>
                    <select id="tpl-frequency" onchange="toggleFrequencyUI()" class="w-full border border-slate-200 rounded-xl px-4 py-2 mb-4 font-bold bg-slate-50 outline-none"><option value="monthly">Monthly (Dates)</option><option value="weekly">Weekly (Days)</option><option value="custom">Specific Yearly Dates</option></select>
                    <div id="tpl-ui-monthly" class="transition-all"><label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Select Dates</label><div class="grid grid-cols-7 gap-1.5" id="tpl-monthly-grid"></div></div>
                    <div id="tpl-ui-weekly" class="hide transition-all"><label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Select Days</label><div class="flex justify-between" id="tpl-weekly-days"></div></div>
                    <div id="tpl-ui-custom" class="hide transition-all"><label class="block text-[11px] font-bold text-slate-500 mb-2 uppercase tracking-wider">Add Dates (MM/DD)</label><div class="flex gap-2 mb-2"><input type="number" id="tpl-custom-mm" placeholder="MM" class="w-20 border border-slate-200 rounded-xl px-3 py-2 text-center outline-none bg-slate-50"><span class="text-slate-400 font-bold self-center">/</span><input type="number" id="tpl-custom-dd" placeholder="DD" class="w-20 border border-slate-200 rounded-xl px-3 py-2 text-center outline-none bg-slate-50"><button type="button" onclick="addCustomDateToDraft()" class="bg-slate-800 text-white px-4 rounded-xl font-bold">Add</button></div><div id="draft-custom-dates" class="flex flex-wrap gap-2 mt-3"></div></div>
                </div>
                <button type="submit" id="tpl-save-btn" class="w-full bg-brand-600 text-white py-3.5 rounded-xl font-bold shadow-md">Save Rule</button>
            </form>
        </div>
    </div>

    <!-- FIREBASE ENGINE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkZHoWGByIZXzFSGjrZMHgEytwdqyZLqE",
            authDomain: "buft-b0d7f.firebaseapp.com",
            projectId: "buft-b0d7f",
            storageBucket: "buft-b0d7f.firebasestorage.app",
            messagingSenderId: "724127677004",
            appId: "1:724127677004:web:080d212affb3cb87ccd2e9",
            measurementId: "G-NDCGFDJEGC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- CRITICAL IPAD/SAFARI STABILITY FIX: Forced Long Polling ---
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        let currentUser = null;
        let dataLoaded = { settings: false, txns: false, tpls: false };
        let hasInitializedCore = false; 

        const REAL_CURRENT_DATE = new Date(); 
        const WINDOW_START = new Date(2025, 0, 1);
        const WINDOW_END = new Date(2026, 11, 31);

        window.state = { currentDate: new Date(REAL_CURRENT_DATE), bankBalance: 0, templateViewMode: 'category', initializedMonths: [], transactions: [], templates: [], hasAcceptedTerms: false };

        // RESTORED UI DATA
        window.categoryConfig = {
            withdrawal: [ { name: 'Home', color: 'bg-indigo-100 text-indigo-700' }, { name: 'Services', color: 'bg-lime-100 text-lime-800' }, { name: 'Subscription', color: 'bg-purple-100 text-purple-700' }, { name: 'Auto', color: 'bg-orange-100 text-orange-700' }, { name: 'CreditCards', color: 'bg-rose-100 text-rose-700' }, { name: 'Utility', color: 'bg-cyan-100 text-cyan-700' }, { name: 'Entertainment', color: 'bg-pink-100 text-pink-700' }, { name: 'Groceries', color: 'bg-emerald-100 text-emerald-700' }, { name: 'Other', color: 'bg-slate-100 text-slate-700' } ],
            deposit: [ { name: 'Direct Deposit', color: 'bg-emerald-100 text-emerald-800' }, { name: 'Adjustment', color: 'bg-blue-100 text-blue-800' }, { name: 'Other Deposit', color: 'bg-teal-100 text-teal-800' } ]
        };
        const daysOfWeek = [ { id: 0, label: 'S' }, { id: 1, label: 'M' }, { id: 2, label: 'T' }, { id: 3, label: 'W' }, { id: 4, label: 'T' }, { id: 5, label: 'F' }, { id: 6, label: 'S' } ];
        let tempCustomDates = []; 
        let cashflowChartObj = null; let categoryChartObj = null; let balanceTrendChartObj = null;

        // AUTH LISTENER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('hide');
                    document.getElementById('main-app').classList.remove('hide');
                    setTimeout(() => document.getElementById('main-app').classList.remove('opacity-0'), 10);
                }, 500);
                setupCloudSync();
            } else {
                currentUser = null;
                document.getElementById('main-app').classList.add('hide');
                document.getElementById('login-overlay').classList.remove('hide');
            }
        });

        window.loginWithGoogle = () => { signInWithPopup(auth, new GoogleAuthProvider()).catch(err => alert("Login Error: " + err.message)); };
        window.logoutUser = () => signOut(auth).then(() => location.reload());

        // CLOUD SYNC ENGINE
        async function setupCloudSync() {
            const uid = currentUser.uid;
            const settingsRef = doc(db, 'users', uid, 'settings', 'main');
            
            // --- SELF-HEALING: Profile check to kickstart the bouncer ---
            try {
                const snap = await getDoc(settingsRef);
                if (!snap.exists()) {
                    await setDoc(settingsRef, { bankBalance: 0, initializedMonths: [], hasAcceptedTerms: false });
                }

                onSnapshot(settingsRef, (docSnap) => {
                    if(docSnap.exists()) {
                        state.bankBalance = docSnap.data().bankBalance || 0;
                        state.initializedMonths = docSnap.data().initializedMonths || [];
                        state.hasAcceptedTerms = docSnap.data().hasAcceptedTerms || false;
                    }
                    dataLoaded.settings = true;
                    checkReadyToInit();
                }, (err) => console.error("Settings Sync Error:", err));

                onSnapshot(collection(db, 'users', uid, 'templates'), (snapshot) => {
                    let tpls = []; snapshot.forEach(doc => tpls.push(doc.data()));
                    state.templates = tpls; dataLoaded.tpls = true; checkReadyToInit();
                });

                onSnapshot(collection(db, 'users', uid, 'transactions'), (snapshot) => {
                    let txns = []; snapshot.forEach(doc => txns.push(doc.data()));
                    state.transactions = txns; dataLoaded.txns = true; checkReadyToInit();
                });
            } catch (err) {
                console.error("Initial connection error:", err);
            }
        }

        async function checkReadyToInit() {
            if (dataLoaded.settings && dataLoaded.txns && dataLoaded.tpls) {
                if (!hasInitializedCore) {
                    if (!state.hasAcceptedTerms) {
                        document.getElementById('data-loader').classList.add('hidden');
                        const gate = document.getElementById('access-gate-overlay');
                        gate.classList.remove('hidden');
                        setTimeout(() => gate.classList.remove('opacity-0'), 10);
                        return;
                    }
                    hasInitializedCore = true;
                    document.getElementById('data-loader').classList.add('hidden');
                    document.getElementById('access-gate-overlay').classList.add('hide');
                    await initializeMonth(state.currentDate.getFullYear(), state.currentDate.getMonth());
                    await processAutoClear();
                    renderApp();
                    scrollToTodayDivider();
                } else { renderApp(); }
            }
        }

        window.verifyAccessCode = async (e) => {
            e.preventDefault();
            if (document.getElementById('access-code-input').value.trim().toUpperCase() === 'L337') {
                await setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { hasAcceptedTerms: true }, { merge: true });
                state.hasAcceptedTerms = true;
                hasInitializedCore = false; 
                checkReadyToInit();
            } else document.getElementById('access-error').classList.remove('hidden');
        }

        // MONTHLY LOGIC
        function getMonthKey(year, monthIndex) { return `${year}-${(monthIndex + 1).toString().padStart(2, '0')}`; }

        async function initializeMonth(year, monthIndex) {
            const monthKey = getMonthKey(year, monthIndex);
            if (state.initializedMonths.includes(monthKey)) return;
            state.initializedMonths.push(monthKey);
            const batch = writeBatch(db);
            batch.set(doc(db, 'users', currentUser.uid, 'settings', 'main'), { initializedMonths: state.initializedMonths }, { merge: true });

            state.templates.forEach(tpl => {
                const monthStr = (monthIndex + 1).toString().padStart(2, '0');
                let datesToInject = [];
                if (tpl.frequency === 'monthly') {
                    tpl.monthlyDays.forEach(day => {
                        const d = Math.min(day, new Date(year, monthIndex + 1, 0).getDate()); 
                        datesToInject.push(`${year}-${monthStr}-${d.toString().padStart(2, '0')}`);
                    });
                } else if (tpl.frequency === 'weekly') {
                    let date = new Date(year, monthIndex, 1);
                    while (date.getMonth() === monthIndex) {
                        if (tpl.weeklyDays.includes(date.getDay())) datesToInject.push(`${year}-${monthStr}-${date.getDate().toString().padStart(2, '0')}`);
                        date.setDate(date.getDate() + 1);
                    }
                } else if (tpl.frequency === 'custom') {
                    tpl.customDates.forEach(cd => {
                        const [m, d] = cd.split('/');
                        if (parseInt(m) === monthIndex + 1) datesToInject.push(`${year}-${monthStr}-${d.padStart(2, '0')}`);
                    });
                }
                datesToInject.forEach(dateStr => {
                    const id = `tplgen_${tpl.id}_${dateStr}_${Math.random().toString(36).substr(2, 5)}`;
                    batch.set(doc(db, 'users', currentUser.uid, 'transactions', id), { id, templateId: tpl.id, date: dateStr, name: tpl.name, amount: tpl.amount, type: tpl.type, category: tpl.category, status: 'unprocessed', autoProcess: tpl.autoProcess || false, comment: '' });
                });
            });
            await batch.commit();
        }

        async function processAutoClear() {
            const todayStr = REAL_CURRENT_DATE.toISOString().split('T')[0];
            const batch = writeBatch(db);
            let needsCommit = false;
            state.transactions.forEach(t => {
                if (t.autoProcess && t.status === 'unprocessed' && t.date <= todayStr) {
                    batch.update(doc(db, 'users', currentUser.uid, 'transactions', t.id), { status: 'cleared' });
                    needsCommit = true;
                }
            });
            if(needsCommit) await batch.commit();
        }

        // RENDERING & DASHBOARD
        window.renderApp = function() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-display').innerText = `${monthNames[state.currentDate.getMonth()]} ${state.currentDate.getFullYear()}`;
            document.getElementById('manual-bank-balance').value = state.bankBalance.toFixed(2);
            
            const tbody = document.getElementById('ledger-body');
            tbody.innerHTML = '';
            const txns = state.transactions.filter(t => t.date.startsWith(getMonthKey(state.currentDate.getFullYear(), state.currentDate.getMonth()))).sort((a,b) => new Date(a.date) - new Date(b.date));
            const todayStr = REAL_CURRENT_DATE.toISOString().split('T')[0];

            let running = 0; let remain = 0; let income = 0; let expense = 0;
            const expensesByCategory = {}; let trendData = []; let trendLabels = [];

            if (txns.length === 0) tbody.innerHTML = `<tr><td colspan="7" class="py-12 text-center text-slate-400 italic">No entries for this month.</td></tr>`;

            txns.forEach((txn) => {
                if (txn.type === 'deposit') { running += txn.amount; income += txn.amount; if (txn.status !== 'cleared') remain += txn.amount; } 
                else { running -= txn.amount; expense += txn.amount; if (txn.status !== 'cleared') remain -= txn.amount; expensesByCategory[txn.category] = (expensesByCategory[txn.category] || 0) + txn.amount; }

                trendLabels.push(formatDate(txn.date)); trendData.push(running);

                const tr = document.createElement('tr');
                tr.className = `border-b border-slate-50 hover:bg-slate-50/50 group transition-all ${txn.status === 'cleared' ? 'item-cleared' : ''}`;
                const catColor = (categoryConfig[txn.type].find(c => c.name === txn.category) || {color: 'bg-slate-100'}).color;
                tr.innerHTML = `
                    <td class="py-4 px-6 font-medium text-slate-500">${txn.date.split('-')[2]}</td>
                    <td class="py-4 px-6"><div class="flex flex-col"><span class="font-bold text-slate-800 item-name">${txn.name}</span><span class="text-[10px] text-slate-400">${txn.comment || ''}</span></div></td>
                    <td class="py-4 px-6"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${catColor}">${txn.category}</span></td>
                    <td class="py-4 px-6 text-right font-extrabold ${txn.type === 'deposit' ? 'text-emerald-600' : 'text-slate-900'}">${txn.type === 'deposit' ? '+' : ''}$${txn.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="py-4 px-6 text-center"><select onchange="updateStatus('${txn.id}', this.value)" class="text-[10px] font-bold border border-slate-200 rounded-full px-3 py-1 outline-none bg-white"><option value="unprocessed" ${txn.status === 'unprocessed' ? 'selected' : ''}>Uncleared</option><option value="cleared" ${txn.status === 'cleared' ? 'selected' : ''}>Cleared</option></select></td>
                    <td class="py-4 px-6 text-right font-extrabold bg-slate-50/30">$${running.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="py-4 px-6 text-center"><div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="openCommentModal('${txn.id}')" class="text-slate-300 hover:text-brand-500"><i class="ph-bold ph-chat-text"></i></button><button onclick="deleteTransaction('${txn.id}')" class="text-slate-300 hover:text-rose-500"><i class="ph-bold ph-trash"></i></button></div></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('metric-remaining').innerText = (remain >= 0 ? '+' : '-') + '$' + Math.abs(remain).toLocaleString(undefined, {minimumFractionDigits: 2});
            const proj = state.bankBalance + remain;
            document.getElementById('metric-projected').innerText = '$' + proj.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('metric-projected').className = proj < 0 ? 'text-3xl font-extrabold mt-1 text-rose-400' : 'text-3xl font-extrabold mt-1 text-emerald-400';

            if(!document.getElementById('view-templates').classList.contains('hide')) renderTemplates();
            if(!document.getElementById('view-dashboard').classList.contains('hide')) renderDashboard(income, expense, expensesByCategory, trendLabels, trendData);
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container'); container.innerHTML = '';
            let groups = {}; state.templates.forEach(tpl => { const key = state.templateViewMode === 'category' ? tpl.category : tpl.frequency; if(!groups[key]) groups[key] = []; groups[key].push(tpl); });
            Object.keys(groups).sort().forEach(g => {
                const section = document.createElement('div');
                section.innerHTML = `<h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 border-b pb-2">${g}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
                const grid = section.querySelector('div');
                groups[g].forEach(tpl => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-3xl border border-slate-200 shadow-sm transition-all hover:shadow-md";
                    div.innerHTML = `<div class="flex justify-between mb-4"><span class="bg-brand-50 text-brand-600 px-2 py-1 rounded text-[10px] font-bold uppercase">${tpl.category}</span><button onclick="deleteTemplate('${tpl.id}')" class="text-slate-300 hover:text-rose-500"><i class="ph-bold ph-trash"></i></button></div><h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">${tpl.name}</h3><div class="text-2xl font-black text-slate-900">$${tpl.amount.toFixed(2)}</div><p class="text-[10px] text-slate-400 mt-4">${tpl.details || ''}</p>`;
                    grid.appendChild(div);
                });
                container.appendChild(section);
            });
        }

        function renderDashboard(income, expense, catMap, labels, trend) {
            if (cashflowChartObj) cashflowChartObj.destroy();
            if (categoryChartObj) categoryChartObj.destroy();
            if (balanceTrendChartObj) balanceTrendChartObj.destroy();

            const flowCtx = document.getElementById('cashflowChart').getContext('2d');
            cashflowChartObj = new Chart(flowCtx, { type: 'bar', data: { labels: ['Income', 'Withdrawals'], datasets: [{ data: [income, expense], backgroundColor: ['#10b981', '#f43f5e'], borderRadius: 12 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            const catCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChartObj = new Chart(catCtx, { type: 'doughnut', data: { labels: Object.keys(catMap), datasets: [{ data: Object.values(catMap), backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#06b6d4', '#10b981', '#64748b'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } } });

            const trendCtx = document.getElementById('balanceTrendChart').getContext('2d');
            balanceTrendChartObj = new Chart(trendCtx, { type: 'line', data: { labels: labels, datasets: [{ data: trend, borderColor: '#6366f1', fill: false, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        // HELPERS & ACTIONS
        window.switchTab = (tab) => {
            ['ledger', 'templates', 'dashboard'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hide'); document.getElementById(`nav-${t}`).classList.remove('bg-brand-50', 'text-brand-600'); document.getElementById(`nav-${t}`).classList.add('text-slate-500'); });
            document.getElementById(`view-${tab}`).classList.remove('hide'); document.getElementById(`nav-${tab}`).classList.add('bg-brand-50', 'text-brand-600'); renderApp();
        };

        window.updateStatus = (id, status) => setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), { status }, { merge: true });
        window.deleteTransaction = (id) => { if(confirm("Remove entry?")) deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id)); };
        window.deleteTemplate = (id) => { if(confirm("Remove rule?")) deleteDoc(doc(db, 'users', currentUser.uid, 'templates', id)); };
        window.updateBankBalance = (val) => setDoc(doc(db, 'users', currentUser.uid, 'settings', 'main'), { bankBalance: parseFloat(val) }, { merge: true });
        window.changeMonth = (delta) => { state.currentDate.setMonth(state.currentDate.getMonth() + delta); renderApp(); };
        window.goToToday = () => { state.currentDate = new Date(REAL_CURRENT_DATE); renderApp(); };
        
        window.openModal = function(id) { document.getElementById('modal-'+id).classList.remove('hidden'); document.getElementById('modal-'+id).classList.add('flex'); setTimeout(() => { document.getElementById('modal-'+id).classList.remove('opacity-0'); document.getElementById('modal-'+id).querySelector('div').classList.remove('scale-95'); }, 10); };
        window.closeModal = function(id) { document.getElementById('modal-'+id).classList.add('opacity-0'); document.getElementById('modal-'+id).querySelector('div').classList.add('scale-95'); setTimeout(() => document.getElementById('modal-'+id).classList.add('hidden'), 300); };
        window.openTransactionModal = () => { document.getElementById('form-transaction').reset(); document.getElementById('txn-date').value = new Date().toISOString().split('T')[0]; updateCategoryOptions('txn-category', 'withdrawal'); openModal('transaction'); };
        window.openTemplateModal = () => { document.getElementById('form-template').reset(); setupWeeklyCheckboxes(); setupMonthlyGrid(); toggleFrequencyUI(); updateCategoryOptions('tpl-category', 'withdrawal'); openModal('template'); };
        window.openCommentModal = (id) => { const txn = state.transactions.find(t => t.id === id); if(!txn) return; document.getElementById('edit-comment-id').value = id; document.getElementById('edit-comment-text').value = txn.comment || ''; openModal('comment'); };
        window.saveLedgerComment = () => { const id = document.getElementById('edit-comment-id').value, text = document.getElementById('edit-comment-text').value; setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), { comment: text }, { merge: true }); closeModal('comment'); };

        window.updateCategoryOptions = (id, type) => { const el = document.getElementById(id); el.innerHTML = categoryConfig[type].map(c => `<option value="${c.name}">${c.name}</option>`).join(''); };

        window.handleTransactionSubmit = async (e) => {
            e.preventDefault();
            const id = 't_' + Date.now();
            await setDoc(doc(db, 'users', currentUser.uid, 'transactions', id), { id, date: document.getElementById('txn-date').value, name: document.getElementById('txn-name').value, amount: parseFloat(document.getElementById('txn-amount').value), type: document.getElementById('txn-type').value, category: document.getElementById('txn-category').value, status: 'unprocessed', comment: document.getElementById('txn-comment').value });
            closeModal('transaction');
        };

        window.handleTemplateSubmit = async (e) => {
            e.preventDefault();
            const id = 'tpl_' + Date.now(), freq = document.getElementById('tpl-frequency').value;
            let rule = { id, name: document.getElementById('tpl-name').value, amount: parseFloat(document.getElementById('tpl-amount').value), type: document.getElementById('tpl-type').value, category: document.getElementById('tpl-category').value, frequency: freq, autoProcess: document.getElementById('tpl-autoprocess').checked, details: document.getElementById('tpl-details').value };
            if(freq === 'monthly') rule.monthlyDays = Array.from(document.querySelectorAll('.tpl-month-val:checked')).map(c => parseInt(c.value));
            else if(freq === 'weekly') rule.weeklyDays = Array.from(document.querySelectorAll('.tpl-day-val:checked')).map(c => parseInt(c.value));
            else rule.customDates = [...tempCustomDates];
            await setDoc(doc(db, 'users', currentUser.uid, 'templates', id), rule);
            closeModal('template');
        };

        window.setTemplateView = (mode) => { state.templateViewMode = mode; renderTemplates(); };
        window.toggleFrequencyUI = () => { const f = document.getElementById('tpl-frequency').value; ['monthly', 'weekly', 'custom'].forEach(v => document.getElementById(`tpl-ui-${v}`).classList.toggle('hide', v !== f)); };
        window.addCustomDateToDraft = () => { const m = document.getElementById('tpl-custom-mm').value.padStart(2, '0'), d = document.getElementById('tpl-custom-dd').value.padStart(2, '0'); if(m > 0 && m <= 12 && d > 0 && d <= 31) { const val = `${m}/${d}`; if(!tempCustomDates.includes(val)) { tempCustomDates.push(val); renderDraftCustomDates(); } } };
        function renderDraftCustomDates() { document.getElementById('draft-custom-dates').innerHTML = tempCustomDates.map(d => `<div class="bg-brand-50 text-brand-700 px-2 py-1 rounded text-xs font-bold flex items-center">${d} <button type="button" onclick="tempCustomDates=tempCustomDates.filter(x=>x!=='${d}');renderDraftCustomDates()" class="ml-1"><i class="ph-bold ph-x"></i></button></div>`).join(''); }

        function formatDate(dateStr) { const [y, m, d] = dateStr.split('-'); return new Date(y, m - 1, d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function setupWeeklyCheckboxes() { document.getElementById('tpl-weekly-days').innerHTML = daysOfWeek.map(d => `<label class="day-checkbox cursor-pointer relative"><input type="checkbox" value="${d.id}" class="peer sr-only tpl-day-val"><div class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-slate-200 bg-white text-slate-500 font-bold transition-all peer-hover:border-brand-300">${d.label}</div></label>`).join(''); }
        function setupMonthlyGrid() { let html = ''; for(let i=1; i<=31; i++) html += `<label class="day-checkbox cursor-pointer relative"><input type="checkbox" value="${i}" class="peer sr-only tpl-month-val"><div class="w-8 h-8 rounded-full flex items-center justify-center border border-slate-200 bg-white text-slate-600 text-xs font-bold transition-all hover:border-brand-300">${i}</div></label>`; document.getElementById('tpl-monthly-grid').innerHTML = html; }
        window.scrollToTodayDivider = () => { setTimeout(() => { const el = document.getElementById('today-divider'); if(el) el.scrollIntoView({behavior:'smooth'}); }, 100); };
        
        setupWeeklyCheckboxes(); setupMonthlyGrid();
    </script>
</body>
</html>

